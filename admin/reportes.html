<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reportes | Admin</title>
    <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@400;500;600;700&family=Montserrat:wght@300;400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="stylesheet" href="../css/admin.css">
</head>
<body>
    <!-- Mobile Menu Toggle -->
    <button class="mobile-menu-toggle" id="mobile-menu-toggle">
        <i class="fas fa-bars"></i>
    </button>
    
    <!-- Mobile Overlay -->
    <div class="mobile-overlay" id="mobile-overlay"></div>
    
    <!-- Sidebar -->
    <aside class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <img src="../assets/logo.png" alt="Logo" style="height: 60px; margin-bottom: 10px;">
            <span class="sidebar-subtitle">Admin</span>
        </div>
        
        <nav class="sidebar-nav">
            <a href="/admin/" class="nav-item">
                <span class="nav-icon"><i class="fas fa-chart-line"></i></span>
                <span>Dashboard</span>
            </a>
            <a href="/admin/calendario.html" class="nav-item">
                <span class="nav-icon"><i class="far fa-calendar-alt"></i></span>
                <span>Calendario</span>
            </a>
            <a href="/admin/clientes.html" class="nav-item">
                <span class="nav-icon"><i class="fas fa-users"></i></span>
                <span>Clientes</span>
            </a>
            <a href="/admin/membresias.html" class="nav-item">
                <span class="nav-icon"><i class="fas fa-crown"></i></span>
                <span>Membres√≠as</span>
            </a>
            <a href="/admin/reportes.html" class="nav-item active">
                <span class="nav-icon"><i class="fas fa-file-invoice-dollar"></i></span>
                <span>Reportes</span>
            </a>
        </nav>
        
        <div class="sidebar-footer">
            <button class="btn-logout" onclick="logout()">Cerrar Sesi√≥n</button>
        </div>
    </aside>
    
    <!-- Main Content -->
    <main class="main-content">
        <header class="main-header">
            <div class="header-title">
                <h2>Reportes y Analytics</h2>
                <p class="header-date">An√°lisis de ventas y rendimiento</p>
            </div>
        </header>
        
        <!-- Period Selector -->
        <section class="content-section">
            <div class="filters-bar">
                <select id="report-type" class="search-input" style="width: auto;">
                    <option value="sales">Reporte de Ventas</option>
                    <option value="services">Servicios M√°s Populares</option>
                    <option value="memberships">Reporte de Membres√≠as</option>
                </select>
                
                <select id="period-type" class="search-input" style="width: auto;" onchange="updatePeriodInputs()">
                    <option value="day">D√≠a</option>
                    <option value="week">Semana</option>
                    <option value="month" selected>Mes</option>
                    <option value="year">A√±o</option>
                    <option value="custom">Personalizado</option>
                </select>
                
                <input type="date" id="start-date" class="search-input" style="width: auto; display: none;">
                <input type="date" id="end-date" class="search-input" style="width: auto; display: none;">
                
                <button class="btn btn-primary" onclick="generateReport()">Generar Reporte</button>
                <button class="btn btn-secondary" onclick="exportReport()"><i class="fas fa-download"></i> Exportar</button>
            </div>
        </section>
        
        <!-- Stats Summary -->
        <section class="stats-grid" id="report-stats" style="display: none;">
            <div class="stat-card">
                <div class="stat-icon"><i class="fas fa-dollar-sign"></i></div>
                <div class="stat-content">
                    <span class="stat-value" id="stat-total-sales">$0</span>
                    <span class="stat-label">Total de Ventas</span>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon"><i class="far fa-calendar-check"></i></div>
                <div class="stat-content">
                    <span class="stat-value" id="stat-total-appointments">0</span>
                    <span class="stat-label">Citas Completadas</span>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon"><i class="fas fa-chart-bar"></i></div>
                <div class="stat-content">
                    <span class="stat-value" id="stat-avg-sale">$0</span>
                    <span class="stat-label">Ticket Promedio</span>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon"><i class="fas fa-users"></i></div>
                <div class="stat-content">
                    <span class="stat-value" id="stat-unique-clients">0</span>
                    <span class="stat-label">Clientes Atendidos</span>
                </div>
            </div>
        </section>
        
        <!-- Report Content -->
        <section class="content-section">
            <div class="section-header">
                <h3 id="report-title">Reporte de Ventas</h3>
                <span id="report-period" style="font-size: 0.9rem; opacity: 0.7;"></span>
            </div>
            
            <div id="report-container">
                <p class="empty-message">Selecciona un per√≠odo y haz clic en "Generar Reporte"</p>
            </div>
        </section>
    </main>
    
    <script src="../js/admin.js"></script>
    <script>
        checkAuth();
        
        let currentReportData = null;
        
        // Initialize dates
        const today = new Date();
        const firstDayOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);
        const lastDayOfMonth = new Date(today.getFullYear(), today.getMonth() + 1, 0);
        
        document.getElementById('start-date').value = firstDayOfMonth.toISOString().split('T')[0];
        document.getElementById('end-date').value = lastDayOfMonth.toISOString().split('T')[0];
        
        function updatePeriodInputs() {
            const periodType = document.getElementById('period-type').value;
            const startDateInput = document.getElementById('start-date');
            const endDateInput = document.getElementById('end-date');
            
            if (periodType === 'custom') {
                startDateInput.style.display = 'block';
                endDateInput.style.display = 'block';
            } else {
                startDateInput.style.display = 'none';
                endDateInput.style.display = 'none';
            }
        }
        
        function getPeriodDates() {
            const periodType = document.getElementById('period-type').value;
            const today = new Date();
            let startDate, endDate;
            
            switch (periodType) {
                case 'day':
                    startDate = endDate = today.toISOString().split('T')[0];
                    break;
                    
                case 'week':
                    const startOfWeek = new Date(today);
                    startOfWeek.setDate(today.getDate() - today.getDay());
                    startDate = startOfWeek.toISOString().split('T')[0];
                    
                    const endOfWeek = new Date(startOfWeek);
                    endOfWeek.setDate(startOfWeek.getDate() + 6);
                    endDate = endOfWeek.toISOString().split('T')[0];
                    break;
                    
                case 'month':
                    const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
                    const lastDay = new Date(today.getFullYear(), today.getMonth() + 1, 0);
                    startDate = firstDay.toISOString().split('T')[0];
                    endDate = lastDay.toISOString().split('T')[0];
                    break;
                    
                case 'year':
                    startDate = `${today.getFullYear()}-01-01`;
                    endDate = `${today.getFullYear()}-12-31`;
                    break;
                    
                case 'custom':
                    startDate = document.getElementById('start-date').value;
                    endDate = document.getElementById('end-date').value;
                    if (!startDate || !endDate) {
                        throw new Error('Selecciona un rango de fechas v√°lido');
                    }
                    break;
            }
            
            return { start_date: startDate, end_date: endDate };
        }
        
        function getPeriodLabel() {
            const periodType = document.getElementById('period-type').value;
            const { start_date, end_date } = getPeriodDates();
            
            if (periodType === 'day') {
                return formatDate(start_date);
            } else if (start_date === end_date) {
                return formatDate(start_date);
            } else {
                return `${formatDate(start_date)} - ${formatDate(end_date)}`;
            }
        }
        
        async function generateReport() {
            const reportType = document.getElementById('report-type').value;
            
            try {
                const params = getPeriodDates();
                const periodLabel = getPeriodLabel();
                
                document.getElementById('report-period').textContent = periodLabel;
                document.getElementById('report-container').innerHTML = `
                    <div class="loading">
                        <div class="loading-spinner"></div>
                        <p>Generando reporte...</p>
                    </div>
                `;
                
                if (reportType === 'sales') {
                    await generateSalesReport(params);
                } else if (reportType === 'services') {
                    await generateServicesReport(params);
                } else if (reportType === 'memberships') {
                    await generateMembershipsReport(params);
                }
                
            } catch (error) {
                console.error('Error generating report:', error);
                showToast(error.message || 'Error al generar el reporte', 'error');
                document.getElementById('report-container').innerHTML = 
                    `<p class="empty-message" style="color: var(--error)">${error.message || 'Error al generar el reporte'}</p>`;
            }
        }
        
        async function generateSalesReport(params) {
            const data = await AdminAPI.getSalesReport(params);
            currentReportData = data;
            
            document.getElementById('report-title').textContent = 'Reporte de Ventas';
            
            // Update stats
            const stats = document.getElementById('report-stats');
            stats.style.display = 'grid';
            
            document.getElementById('stat-total-sales').textContent = formatCurrency(data.summary.total_sales || 0);
            document.getElementById('stat-total-appointments').textContent = data.summary.total_appointments || 0;
            document.getElementById('stat-avg-sale').textContent = formatCurrency(data.summary.average_sale || 0);
            document.getElementById('stat-unique-clients').textContent = data.summary.unique_clients || 0;
            
            // Render table
            const container = document.getElementById('report-container');
            
            if (!data.sales || data.sales.length === 0) {
                container.innerHTML = '<p class="empty-message">No hay ventas en este per√≠odo</p>';
                return;
            }
            
            const columns = [
                { field: 'date', label: 'Fecha', format: formatDate },
                { field: 'client_name', label: 'Cliente' },
                { field: 'service_name', label: 'Servicio' },
                { field: 'service_price', label: 'Servicio', format: formatCurrency },
                { field: 'products_total', label: 'Productos', format: (v) => formatCurrency(v || 0) },
                { field: 'discount', label: 'Descuento', format: (v) => formatCurrency(v || 0) },
                { field: 'total', label: 'Total', format: formatCurrency },
                { field: 'payment_method', label: 'M√©todo de Pago' }
            ];
            
            container.innerHTML = createTable(data.sales, columns);
        }
        
        async function generateServicesReport(params) {
            const data = await AdminAPI.getServicesReport(params);
            currentReportData = data;
            
            document.getElementById('report-title').textContent = 'Servicios M√°s Populares';
            
            // Update stats
            const stats = document.getElementById('report-stats');
            stats.style.display = 'grid';
            
            const totalServices = data.services.reduce((sum, s) => sum + parseInt(s.count || 0), 0);
            const totalRevenue = data.services.reduce((sum, s) => sum + parseFloat(s.revenue || 0), 0);
            
            document.getElementById('stat-total-sales').textContent = formatCurrency(totalRevenue);
            document.getElementById('stat-total-appointments').textContent = totalServices;
            document.getElementById('stat-avg-sale').textContent = 
                totalServices > 0 ? formatCurrency(totalRevenue / totalServices) : '$0';
            document.getElementById('stat-unique-clients').textContent = data.summary?.unique_clients || 0;
            
            // Render table
            const container = document.getElementById('report-container');
            
            if (!data.services || data.services.length === 0) {
                container.innerHTML = '<p class="empty-message">No hay datos de servicios en este per√≠odo</p>';
                return;
            }
            
            const columns = [
                { 
                    field: 'service_name', 
                    label: 'Servicio',
                    format: (value, row) => `
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <div style="width: 30px; height: 4px; background: var(--gold); border-radius: 2px;"></div>
                            ${value}
                        </div>
                    `
                },
                { field: 'category', label: 'Categor√≠a' },
                { field: 'count', label: 'Cantidad', format: (v) => parseInt(v) },
                { field: 'revenue', label: 'Ingresos', format: formatCurrency },
                { 
                    field: 'count', 
                    label: 'Popularidad',
                    format: (value, row, allData) => {
                        const maxCount = Math.max(...data.services.map(s => parseInt(s.count)));
                        const percentage = (parseInt(value) / maxCount) * 100;
                        return `
                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                <div style="width: 100px; height: 8px; background: rgba(196, 163, 90, 0.2); border-radius: 4px; overflow: hidden;">
                                    <div style="width: ${percentage}%; height: 100%; background: var(--gold);"></div>
                                </div>
                                <span>${Math.round(percentage)}%</span>
                            </div>
                        `;
                    }
                }
            ];
            
            container.innerHTML = createTable(data.services, columns);
        }
        
        async function generateMembershipsReport(params) {
            const data = await AdminAPI.getMembershipsReport(params);
            currentReportData = data;
            
            document.getElementById('report-title').textContent = 'Reporte de Membres√≠as';
            
            // Update stats
            const stats = document.getElementById('report-stats');
            stats.style.display = 'grid';
            
            document.getElementById('stat-total-sales').textContent = formatCurrency(data.summary.total_revenue || 0);
            document.getElementById('stat-total-appointments').textContent = data.summary.total_memberships || 0;
            document.getElementById('stat-avg-sale').textContent = formatCurrency(data.summary.average_revenue || 0);
            document.getElementById('stat-unique-clients').textContent = data.summary.active_memberships || 0;
            
            // Render table
            const container = document.getElementById('report-container');
            
            if (!data.memberships || data.memberships.length === 0) {
                container.innerHTML = '<p class="empty-message">No hay datos de membres√≠as en este per√≠odo</p>';
                return;
            }
            
            const columns = [
                { 
                    field: 'type_name', 
                    label: 'Plan',
                    format: (value) => {
                        const icons = { gold: 'ü•á', platinum: 'üíé', black: 'üëë' };
                        return `${icons[value.toLowerCase()] || ''} ${value}`;
                    }
                },
                { field: 'count', label: 'Activas', format: (v) => parseInt(v) },
                { field: 'new_count', label: 'Nuevas', format: (v) => parseInt(v || 0) },
                { field: 'cancelled_count', label: 'Canceladas', format: (v) => parseInt(v || 0) },
                { field: 'revenue', label: 'Ingresos', format: formatCurrency },
                { 
                    field: 'revenue', 
                    label: 'Participaci√≥n',
                    format: (value) => {
                        const totalRevenue = data.memberships.reduce((sum, m) => sum + parseFloat(m.revenue || 0), 0);
                        const percentage = totalRevenue > 0 ? (parseFloat(value) / totalRevenue) * 100 : 0;
                        return `${percentage.toFixed(1)}%`;
                    }
                }
            ];
            
            container.innerHTML = createTable(data.memberships, columns);
        }
        
        function exportReport() {
            if (!currentReportData) {
                showToast('Genera un reporte primero', 'warning');
                return;
            }
            
            const reportType = document.getElementById('report-type').value;
            const periodLabel = getPeriodLabel();
            
            let exportData = [];
            let filename = '';
            
            if (reportType === 'sales' && currentReportData.sales) {
                exportData = currentReportData.sales.map(s => ({
                    'Fecha': formatDate(s.date),
                    'Cliente': s.client_name,
                    'Servicio': s.service_name,
                    'Precio Servicio': s.service_price,
                    'Productos': s.products_total || 0,
                    'Descuento': s.discount || 0,
                    'Total': s.total,
                    'M√©todo de Pago': s.payment_method
                }));
                filename = `ventas_${periodLabel}`;
                
            } else if (reportType === 'services' && currentReportData.services) {
                exportData = currentReportData.services.map(s => ({
                    'Servicio': s.service_name,
                    'Categor√≠a': s.category,
                    'Cantidad': s.count,
                    'Ingresos': s.revenue
                }));
                filename = `servicios_${periodLabel}`;
                
            } else if (reportType === 'memberships' && currentReportData.memberships) {
                exportData = currentReportData.memberships.map(m => ({
                    'Plan': m.type_name,
                    'Activas': m.count,
                    'Nuevas': m.new_count || 0,
                    'Canceladas': m.cancelled_count || 0,
                    'Ingresos': m.revenue
                }));
                filename = `membresias_${periodLabel}`;
            }
            
            if (exportData.length > 0) {
                exportToExcel(exportData, filename);
            } else {
                showToast('No hay datos para exportar', 'warning');
            }
        }
        
        // Generate initial report for current month
        setTimeout(() => {
            generateReport();
        }, 500);
    </script>
    
    <!-- Mobile Menu Script -->
    <script>
        const mobileMenuToggle = document.getElementById('mobile-menu-toggle');
        const sidebar = document.getElementById('sidebar');
        const mobileOverlay = document.getElementById('mobile-overlay');
        
        if (mobileMenuToggle && sidebar && mobileOverlay) {
            mobileMenuToggle.addEventListener('click', () => {
                sidebar.classList.toggle('active');
            });
            
            mobileOverlay.addEventListener('click', () => {
                sidebar.classList.remove('active');
            });
            
            document.querySelectorAll('.sidebar .nav-item').forEach(item => {
                item.addEventListener('click', () => {
                    sidebar.classList.remove('active');
                });
            });
        }
    </script>
</body>
</html>
