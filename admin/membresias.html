<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MembresÃ­as | Braco's Admin</title>
    <link rel="icon" href="../assets/logo.png" type="image/png">
    <link
        href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@400;500;600;700&family=Montserrat:wght@300;400;500;600&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="stylesheet" href="css/admin.css">
</head>

<body>
    <!-- Mobile Menu Toggle -->
    <button class="mobile-menu-toggle" id="mobile-menu-toggle" aria-label="Abrir menÃº">
        <i class="fas fa-bars"></i>
    </button>

    <!-- Mobile Overlay -->
    <div class="mobile-overlay" id="mobile-overlay"></div>

    <div class="admin-layout">
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <img src="../assets/logo.png" alt="Logo"
                    style="height: 60px; margin-bottom: 10px; display: block; margin: 0 auto 10px;">
                <p class="sidebar-subtitle">AdministraciÃ³n</p>
            </div>

            <nav class="sidebar-nav">
                <div class="nav-section">
                    <span class="nav-section-title">Principal</span>
                    <a href="index.html" class="nav-item">
                        <span class="nav-icon"><i class="fas fa-chart-line"></i></span>
                        <span>Dashboard</span>
                    </a>
                    <a href="calendario.html" class="nav-item">
                        <span class="nav-icon"><i class="far fa-calendar-alt"></i></span>
                        <span>Calendario</span>
                    </a>
                    <a href="citas.html" class="nav-item">
                        <span class="nav-icon"><i class="fas fa-scissors"></i></span>
                        <span>Citas</span>
                        <span class="badge" id="nav-badge-citas">0</span>
                    </a>
                </div>

                <div class="nav-section">
                    <span class="nav-section-title">GestiÃ³n</span>
                    <a href="clientes.html" class="nav-item">
                        <span class="nav-icon"><i class="fas fa-users"></i></span>
                        <span>Clientes</span>
                    </a>
                    <a href="membresias.html" class="nav-item active">
                        <span class="nav-icon"><i class="fas fa-crown"></i></span>
                        <span>MembresÃ­as</span>
                    </a>
                    <a href="servicios.html" class="nav-item">
                        <span class="nav-icon"><i class="fas fa-cut"></i></span>
                        <span>Servicios</span>
                    </a>
                    <a href="productos.html" class="nav-item">
                        <span class="nav-icon"><i class="fas fa-pump-soap"></i></span>
                        <span>Productos</span>
                    </a>
                </div>

                <div class="nav-section">
                    <span class="nav-section-title">Reportes</span>
                    <a href="reportes.html" class="nav-item">
                        <span class="nav-icon"><i class="fas fa-file-invoice-dollar"></i></span>
                        <span>Ventas</span>
                    </a>
                </div>

                <div class="nav-section">
                    <span class="nav-section-title">Sistema</span>
                    <a href="configuracion.html" class="nav-item">
                        <span class="nav-icon"><i class="fas fa-cog"></i></span>
                        <span>ConfiguraciÃ³n</span>
                    </a>
                </div>
            </nav>

            <div class="sidebar-footer">
                <div class="admin-profile">
                    <div class="admin-avatar" id="admin-avatar">A</div>
                    <div class="admin-info">
                        <div class="admin-name" id="admin-name">Admin</div>
                        <div class="admin-role" id="admin-role">Administrador</div>
                    </div>
                </div>
                <button class="btn-logout" onclick="logout()">Cerrar SesiÃ³n</button>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <header class="main-header">
                <div class="header-title">
                    <h2>GestiÃ³n de MembresÃ­as</h2>
                    <p class="header-date">Administra planes y suscripciones</p>
                </div>
                <div class="header-actions">
                    <button class="btn btn-secondary" onclick="exportMemberships()" style="margin-right: 10px;">
                        <i class="fas fa-file-export"></i> Exportar
                    </button>
                    <button class="btn btn-primary" onclick="openActivateMembershipModal()">+ Activar MembresÃ­a</button>
                </div>
            </header>

            <!-- Catalog Section -->
            <section class="membership-catalog-section">
                <div class="section-header">
                    <h3>CatÃ¡logo de MembresÃ­as</h3>
                    <p class="text-muted">Planes disponibles para venta</p>
                </div>
                <div class="membership-cards-grid">
                    <!-- Golden Card Corte -->
                    <div class="membership-card-display golden">
                        <div class="card-header-display">
                            <span class="card-icon"><i class="fas fa-cut"></i></span>
                            <h4>Golden Card Corte</h4>
                        </div>
                        <div class="card-price-display">
                            $1,500 <span class="currency">MXN</span>
                        </div>
                        <ul class="card-features-display">
                            <li><i class="fas fa-check"></i> 6 Servicios Totales</li>
                            <li><i class="fas fa-check"></i> Corte de Cabello</li>
                            <li><i class="fas fa-check"></i> Ritual de Barba</li>
                            <li><i class="fas fa-check"></i> Servicio DÃºo</li>
                            <li class="restricted"><i class="fas fa-user-lock"></i> Intransferible</li>
                        </ul>
                        <button class="btn btn-primary btn-sm btn-block" onclick="openActivateMembershipModal(8)">Vender
                            Plan</button>
                    </div>

                    <!-- Golden Card NeoCapilar -->
                    <div class="membership-card-display golden">
                        <div class="card-header-display">
                            <span class="card-icon"><i class="fas fa-spa"></i></span>
                            <h4>Golden NeoCapilar</h4>
                        </div>
                        <div class="card-price-display">
                            $3,850 <span class="currency">MXN</span>
                        </div>
                        <ul class="card-features-display">
                            <li><i class="fas fa-check"></i> 8 Servicios Totales (Paga 7)</li>
                            <li><i class="fas fa-check"></i> Terapia Integral Capilar (TIC)</li>
                            <li><i class="fas fa-check"></i> Salud y PrevenciÃ³n</li>
                            <li class="restricted"><i class="fas fa-user-lock"></i> Intransferible</li>
                        </ul>
                        <button class="btn btn-primary btn-sm btn-block" onclick="openActivateMembershipModal(9)">Vender
                            Plan</button>
                    </div>

                    <!-- Black Card -->
                    <div class="membership-card-display black">
                        <div class="card-header-display">
                            <span class="card-icon"><i class="fas fa-crown"></i></span>
                            <h4>Black Card</h4>
                        </div>
                        <div class="card-price-display">
                            $3,300 <span class="currency">MXN</span>
                        </div>
                        <ul class="card-features-display">
                            <li><i class="fas fa-check"></i> 12 Servicios Totales (Paga 11)</li>
                            <li><i class="fas fa-check"></i> Cortes, Barba, Mascarillas</li>
                            <li><i class="fas fa-check"></i> Manicura y Pedicura</li>
                            <li class="highlight"><i class="fas fa-share-alt"></i> Transferible</li>
                        </ul>
                        <button class="btn btn-primary btn-sm btn-block"
                            onclick="openActivateMembershipModal(10)">Vender Plan</button>
                    </div>
                </div>
            </section>

            <!-- Stats -->
            <section class="stats-grid">
                <div class="stat-card">
                    <div class="stat-icon"><i class="fas fa-crown"></i></div>
                    <div class="stat-content">
                        <span class="stat-value" id="stat-active">0</span>
                        <span class="stat-label">Activas</span>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon"><i class="fas fa-exclamation-triangle"></i></div>
                    <div class="stat-content">
                        <span class="stat-value" id="stat-expiring">0</span>
                        <span class="stat-label">Por Vencer (30 dÃ­as)</span>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon"><i class="fas fa-dollar-sign"></i></div>
                    <div class="stat-content">
                        <span class="stat-value" id="stat-revenue">$0</span>
                        <span class="stat-label">Ingresos Mensuales</span>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">ðŸ‘‘</div>
                    <div class="stat-content">
                        <span class="stat-value" id="stat-lifetime">0</span>
                        <span class="stat-label">Lifetime (Black)</span>
                    </div>
                </div>
            </section>

            <!-- Filters -->
            <section class="content-section">
                <div class="filters-bar">
                    <input type="text" id="search-memberships" class="search-input" placeholder="Buscar por cliente...">

                    <select id="filter-status" class="search-input" style="width: auto;">
                        <option value="">Todos los estados</option>
                        <option value="active">Activas</option>
                        <option value="expiring">Por vencer</option>
                        <option value="cancelled">Canceladas</option>
                    </select>

                    <select id="filter-type" class="search-input" style="width: auto;">
                        <option value="">Todos los planes</option>
                        <option value="gold">Gold</option>
                        <option value="platinum">Platinum</option>
                        <option value="black">Black</option>
                    </select>

                    <button class="btn btn-secondary" onclick="exportMemberships()">ðŸ“¥ Exportar</button>
                </div>
            </section>

            <!-- Memberships Table -->
            <section class="content-section">
                <div class="section-header">
                    <h3>MembresÃ­as Activas</h3>
                </div>

                <div id="memberships-container">
                    <div class="loading">
                        <div class="loading-spinner"></div>
                        <p>Cargando membresÃ­as...</p>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <script src="../js/admin.js"></script>
    <script>
        checkAuth();

        let allMemberships = [];
        let filteredMemberships = [];
        let membershipTypes = [];

        // Event listeners
        document.getElementById('search-memberships').addEventListener('input', debounce(applyFilters, 300));
        document.getElementById('filter-status').addEventListener('change', applyFilters);
        document.getElementById('filter-type').addEventListener('change', applyFilters);

        // Load data
        async function loadMemberships() {
            try {
                const data = await AdminAPI.getMemberships();
                allMemberships = data.memberships || [];

                // Update stats
                const active = allMemberships.filter(m => m.status === 'active').length;
                document.getElementById('stat-active').textContent = active;

                const thirtyDaysFromNow = new Date();
                thirtyDaysFromNow.setDate(thirtyDaysFromNow.getDate() + 30);
                const expiring = allMemberships.filter(m => {
                    if (m.status !== 'active' || !m.end_date) return false;
                    const endDate = new Date(m.end_date);
                    return endDate <= thirtyDaysFromNow;
                }).length;
                document.getElementById('stat-expiring').textContent = expiring;

                const monthlyRevenue = allMemberships
                    .filter(m => m.status === 'active' && m.type_name !== 'black')
                    .reduce((sum, m) => sum + parseFloat(m.type_price || 0), 0);
                document.getElementById('stat-revenue').textContent = formatCurrency(monthlyRevenue);

                const lifetime = allMemberships.filter(m =>
                    m.status === 'active' && m.type_name === 'black'
                ).length;
                document.getElementById('stat-lifetime').textContent = lifetime;

                applyFilters();

            } catch (error) {
                console.error('Error loading memberships:', error);
                showToast('Error al cargar las membresÃ­as', 'error');
            }
        }

        function applyFilters() {
            const searchTerm = document.getElementById('search-memberships').value.toLowerCase();
            const statusFilter = document.getElementById('filter-status').value;
            const typeFilter = document.getElementById('filter-type').value;

            filteredMemberships = allMemberships.filter(membership => {
                // Search filter
                if (searchTerm) {
                    const searchText = membership.client_name.toLowerCase();
                    if (!searchText.includes(searchTerm)) return false;
                }

                // Status filter
                if (statusFilter === 'active' && membership.status !== 'active') return false;
                if (statusFilter === 'cancelled' && membership.status !== 'cancelled') return false;
                if (statusFilter === 'expiring') {
                    if (membership.status !== 'active' || !membership.end_date) return false;
                    const thirtyDaysFromNow = new Date();
                    thirtyDaysFromNow.setDate(thirtyDaysFromNow.getDate() + 30);
                    const endDate = new Date(membership.end_date);
                    if (endDate > thirtyDaysFromNow) return false;
                }

                // Type filter
                if (typeFilter && membership.type_name !== typeFilter) return false;

                return true;
            });

            renderMemberships();
        }

        function renderMemberships() {
            const container = document.getElementById('memberships-container');

            if (filteredMemberships.length === 0) {
                container.innerHTML = '<p class="empty-message">No se encontraron membresÃ­as</p>';
                return;
            }

            const columns = [
                {
                    field: 'client_name',
                    label: 'Cliente',
                    format: (value, row) => `
                        <div>
                            <div class="font-medium">${value}</div>
                            <div class="text-sm text-muted">${formatPhone(row.client_phone)}</div>
                        </div>
                    `
                },
                {
                    field: 'folio_number',
                    label: 'Folio',
                    format: (value) => value ? `<span class="badge" style="background: rgba(196, 163, 90, 0.1); color: var(--primary-gold);">${value}</span>` : '-'
                },
                {
                    field: 'membership_type',
                    label: 'Plan',
                    format: (value) => `<span class="font-medium text-gold">${value}</span>`
                },
                {
                    field: 'activation_date',
                    label: 'Inicio',
                    format: (value) => formatDate(value)
                },
                {
                    field: 'expiration_date',
                    label: 'Vencimiento',
                    format: (value, row) => {
                        if (!value) return '<span class="text-success">Lifetime</span>';

                        const date = new Date(value);
                        const today = new Date();
                        const diffTime = date - today;
                        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

                        let badge = '';
                        if (diffDays < 0) {
                            badge = ' <span class="badge inactive">Vencida</span>';
                        } else if (diffDays <= 7) {
                            badge = ' <span class="badge expiring">Por vencer</span>';
                        }
                        return formatDate(value) + badge;
                    }
                },
                {
                    field: 'remaining_services',
                    label: 'Servicios',
                    format: (value, row) => {
                        // Check for unlimited (e.g. Black) based on type or value
                        if (row.membership_type.toLowerCase() === 'black') return 'â™¾ï¸';
                        return `${value !== undefined ? value : '?'} est.`;
                    }
                },
                {
                    field: 'status',
                    label: 'Estado',
                    format: (value) => {
                        const badges = {
                            active: '<span class="badge active">Activa</span>',
                            cancelled: '<span class="badge inactive">Cancelada</span>'
                        };
                        return badges[value] || value;
                    }
                },
                {
                    field: 'id',
                    label: 'Acciones',
                    format: (value, row) => `
                        <div class="actions">
                            <button class="btn-icon" onclick="viewMembershipDetail(${value})" title="Ver detalles"><i class="fas fa-eye"></i></button>
                            <button class="btn-icon" onclick="copyCardLink('${row.uuid}')" title="Copiar Link de Tarjeta"><i class="fas fa-copy"></i></button>
                            <button class="btn-icon" onclick="sendCardByWhatsApp('${row.uuid}', '${row.client_phone}', '${row.client_name}')" title="Enviar por WhatsApp"><i class="fab fa-whatsapp"></i></button>
                            ${row.status === 'active' ?
                            `<button class="btn-icon" onclick="cancelMembership(${value})" title="Cancelar"><i class="fas fa-ban"></i></button>`
                            : ''}
                        </div>
                    `
                }
            ];

            container.innerHTML = createTable(filteredMemberships, columns);
        }

        function copyCardLink(uuid) {
            const url = `https://braco-s-barberia-production.up.railway.app/tarjeta.html?id=${uuid}`;
            navigator.clipboard.writeText(url).then(() => {
                const toast = document.createElement('div');
                toast.textContent = 'Link copiado al portapapeles';
                toast.style.cssText = 'position: fixed; bottom: 20px; right: 20px; background: #4CAF50; color: white; padding: 12px 24px; border-radius: 4px; z-index: 10000; animation: fadeIn 0.3s, fadeOut 0.3s 2s forwards;';
                document.body.appendChild(toast);
                setTimeout(() => toast.remove(), 2500);
            }).catch(err => {
                console.error('Error al copiar link: ', err);
                alert('No se pudo copiar el link automÃ¡ticamente. Por favor selecciÃ³nalo: ' + url);
            });
        }

        function sendCardByWhatsApp(uuid, phone, clientName) {
            // Limpiar el nÃºmero de telÃ©fono (quitar espacios, guiones, etc)
            const cleanPhone = phone.replace(/\D/g, '');

            // Construir el link de la tarjeta
            const cardUrl = `https://braco-s-barberia-production.up.railway.app/tarjeta.html?id=${uuid}`;

            // Mensaje personalizado
            const message = `Hola *${clientName}*,\n\nAquÃ­ estÃ¡ el link de tu *Tarjeta Digital de MembresÃ­a* de Braco's BarberÃ­a:\n\n${cardUrl}\n\nGuÃ¡rdalo y presÃ©ntalo en tu prÃ³xima visita.\n\n*Gracias por ser miembro de Braco's.*`;

            // Codificar el mensaje para URL
            const encodedMessage = encodeURIComponent(message);

            // Abrir WhatsApp con el mensaje pre-escrito
            const whatsappUrl = `https://wa.me/521${cleanPhone}?text=${encodedMessage}`;
            window.open(whatsappUrl, '_blank');
        }

        // ... existing openActivateMembershipModal ...

        function getCardHtml(membership) {
            const type = (membership.membership_type || '').toLowerCase();
            let cardClass = '';
            let typeTitle = '';
            let typeSubtitle = '';
            let totalDiamonds = 0;

            // Configuration based on type
            if (type.includes('black')) {
                cardClass = 'card-black';
                typeTitle = 'BLACK CARD';
                typeSubtitle = 'Exclusivo â€¢ 12 Servicios';
                totalDiamonds = 12;
            } else if (type.includes('neocapilar')) {
                cardClass = 'card-neocapilar';
                typeTitle = 'NEOCAPILAR';
                typeSubtitle = 'Tratamiento Premium';
                totalDiamonds = 8;
            } else {
                cardClass = 'card-golden';
                typeTitle = 'GOLDEN CARD';
                typeSubtitle = 'BarberÃ­a & PeluquerÃ­a';
                totalDiamonds = 6;
            }

            // Generate Diamonds
            const usedServices = membership.used_services || 0;
            // For Black Card (grid layout) vs others (flex)
            const isGrid = totalDiamonds > 8;
            const containerClass = isGrid ? 'diamonds-grid' : 'diamonds-container';

            let diamondsHtml = `<div class="${containerClass}">`;

            for (let i = 0; i < totalDiamonds; i++) {
                const isFilled = i < usedServices;
                const diamondClass = isFilled ? 'diamond filled' : 'diamond empty';

                // SVG differences (Gold vs Silver gradients)
                const isSilver = cardClass === 'card-black';
                const gradientPrefix = isSilver ? 'silver' : 'gold';
                const strokeColor = isSilver ? '#666' : '#8B7335';

                // Define gradients once if not exists (handled in modal wrapper or inline)
                // For simplicity, we'll embed defs in the first diamond or use a shared SVG definition

                diamondsHtml += `
                    <div class="${diamondClass}">
                        <svg viewBox="0 0 24 24" fill="none">
                            <path d="M12 2L2 9L12 22L22 9L12 2Z" fill="url(#${gradientPrefix}Gradient1)" stroke="${strokeColor}" stroke-width="0.5"/>
                            ${isFilled ? `
                            <path d="M12 2L7 9H17L12 2Z" fill="url(#${gradientPrefix}Gradient2)" opacity="${isSilver ? 0.8 : 0.7}"/>
                            <path d="M7 9L12 22L2 9H7Z" fill="url(#${gradientPrefix}Gradient3)" opacity="${isSilver ? 0.6 : 0.5}"/>
                            ` : ''}
                        </svg>
                    </div>
                `;
            }
            diamondsHtml += '</div>';

            // SVG Definitions (Hidden but accessible for URL references)
            const defs = `
                <svg width="0" height="0" style="position: absolute;">
                    <defs>
                        <linearGradient id="goldGradient1" x1="0%" y1="0%" x2="100%" y2="100%">
                            <stop offset="0%" style="stop-color:#E8D5A3"/>
                            <stop offset="50%" style="stop-color:#C4A35A"/>
                            <stop offset="100%" style="stop-color:#8B7335"/>
                        </linearGradient>
                        <linearGradient id="goldGradient2" x1="0%" y1="0%" x2="100%" y2="100%">
                            <stop offset="0%" style="stop-color:#FFF8E7"/>
                            <stop offset="100%" style="stop-color:#C4A35A"/>
                        </linearGradient>
                        <linearGradient id="goldGradient3" x1="0%" y1="0%" x2="100%" y2="100%">
                            <stop offset="0%" style="stop-color:#8B7335"/>
                            <stop offset="100%" style="stop-color:#5C4D23"/>
                        </linearGradient>
                        <linearGradient id="silverGradient1" x1="0%" y1="0%" x2="100%" y2="100%">
                            <stop offset="0%" style="stop-color:#E8E8E8"/>
                            <stop offset="30%" style="stop-color:#C0C0C0"/>
                            <stop offset="50%" style="stop-color:#A8A8A8"/>
                            <stop offset="70%" style="stop-color:#C0C0C0"/>
                            <stop offset="100%" style="stop-color:#808080"/>
                        </linearGradient>
                        <linearGradient id="silverGradient2" x1="0%" y1="0%" x2="100%" y2="100%">
                            <stop offset="0%" style="stop-color:#FFFFFF"/>
                            <stop offset="100%" style="stop-color:#C0C0C0"/>
                        </linearGradient>
                        <linearGradient id="silverGradient3" x1="0%" y1="0%" x2="100%" y2="100%">
                            <stop offset="0%" style="stop-color:#808080"/>
                            <stop offset="100%" style="stop-color:#404040"/>
                        </linearGradient>
                    </defs>
                </svg>
            `;

            return `
                ${defs}
                <div class="card-wrapper" onclick="this.classList.toggle('flipped')">
                    <div class="card-flipper">
                        <div class="card-front loyalty-card ${cardClass}">
                            <div class="card-shine"></div>
                            ${[...Array(6)].map(() => '<div class="sparkle"></div>').join('')}
                            
                            <div class="card-inner">
                                <div class="card-header">
                                    <img src="../assets/logo.png" alt="Braco's" class="card-logo" style="width: 80px !important; height: auto !important; max-width: 80px;">
                                    <div class="card-type-wrapper">
                                        <div class="card-type">${typeTitle}</div>
                                        <div class="card-type-sub">${typeSubtitle}</div>
                                    </div>
                                </div>

                                ${diamondsHtml}

                                <div class="card-footer">
                                    <div class="card-number">No. ${membership.folio_number || '---'}</div>
                                    <div class="contact-info">
                                        <div class="phone">${formatPhone(membership.client_phone)}</div>
                                        <div class="social">
                                            <span>â—‰</span> @bracosbarberia
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="card-back" ${cardClass === 'card-black' ? 'style="background: linear-gradient(135deg, #0a0a0a, #1a1a1a); border: 1px solid rgba(196, 163, 90, 0.3);"' : ''}>
                            <div class="address">
                                <strong>UBICACIÃ“N</strong>
                                Heroico Colegio Militar No. 46, Local J<br>
                                Plaza Comercial Hacienda<br>
                                Tequisquiapan, Qro.
                            </div>
                            <div class="card-back-footer">
                                <img src="../assets/logo.png" alt="Braco's" class="back-logo" style="width: 50px !important; height: auto !important;">
                                <div class="qr-placeholder">QR CODE</div>
                            </div>
                        </div>
                    </div>
                </div>
                <p style="text-align: center; margin-top: 1rem; font-size: 0.8rem; color: #888;">Clic en la tarjeta para ver reverso</p>
            `;
        }

        function viewCard(id) {
            const membership = allMemberships.find(m => m.id === id);
            if (!membership) return;

            const content = `
                <div style="padding: 2rem 0; display: flex; justify-content: center;">
                    ${getCardHtml(membership)}
                </div>
            `;

            showModal('cardModal', 'Tarjeta Digital', content);
        }

        // ... existing activateMembership ...

        // Update success modal to show card
        // In activateMembership function:
        /*
            const uuid = response.uuid;
            // Fetch the just created membership to get types and details, or construct pseudo-object
            // For now, let's just construct a pseudo object from form data + prefix/folio
            const pseudoMembership = {
                 membership_type: document.getElementById('membership-type').options[document.getElementById('membership-type').selectedIndex].text.split(' - ')[0],
                 folio_number: document.getElementById('folio-prefix').textContent + document.getElementById('membership-folio').value,
                 client_phone: '55...', // fetch from client select or just leave placeholder
                 used_services: 0
            };
            // Actually, better to just show successful creation and a button to "Ver Tarjeta"
        */


        async function openActivateMembershipModal(preSelectedTypeId = null) {
            // Load clients and membership types for dropdown
            try {
                // Use fetchWithAuth for secured types endpoint
                const [clientsData, typesData] = await Promise.all([
                    AdminAPI.getClients(),
                    fetchWithAuth('/admin/membership-types')
                ]);

                const clients = clientsData.clients || [];
                membershipTypes = typesData.types || [];
                // Store clients globally for later use
                window.membershipClients = clients;

                const content = `
                    <form id="membership-form">
                        <div class="form-group">
                            <label class="form-label">Cliente *</label>
                            <select id="membership-client" class="form-select" required>
                                <option value="">Selecciona un cliente</option>
                                ${clients.map(c => `
                                    <option value="${c.id}" data-phone="${c.phone}" data-name="${c.name}">${c.name} - ${formatPhone(c.phone)}</option>
                                `).join('')}
                            </select>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Plan *</label>
                            <select id="membership-type" class="form-select" required onchange="updateMembershipPreview()">
                                <option value="">Selecciona un plan</option>
                                ${membershipTypes.map(t => `
                                    <option value="${t.id}" data-price="${t.price}" data-services="${t.total_services || 0}" data-transferable="${t.is_transferable}">
                                        ${t.name} - ${formatCurrency(t.price)}
                                    </option>
                                `).join('')}
                            </select>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Folio *</label>
                            <div style="display: flex; gap: 10px; align-items: center;">
                                <span id="folio-prefix" style="background: linear-gradient(135deg, rgba(196, 163, 90, 0.2), rgba(196, 163, 90, 0.1)); padding: 0.75rem 1rem; border-radius: 6px; color: var(--gold); font-weight: 700; min-width: 55px; text-align: center; border: 1px solid rgba(196, 163, 90, 0.3); font-size: 1.1rem;">-</span>
                                <input type="number" id="membership-folio" class="form-input" required placeholder="NÃºmero (ej: 1)" style="flex: 1;">
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">MÃ©todo de Pago *</label>
                            <select id="payment-method" class="form-select" required>
                                <option value="efectivo">ðŸ’µ Efectivo</option>
                                <option value="tarjeta">ðŸ’³ Tarjeta</option>
                                <option value="transferencia">ðŸ“± Transferencia</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Fecha de Inicio</label>
                            <div style="background: rgba(76, 175, 80, 0.1); border: 1px solid rgba(76, 175, 80, 0.3); border-radius: 6px; padding: 0.75rem 1rem; color: #81c784;">
                                <i class="fas fa-calendar-check" style="margin-right: 8px;"></i>
                                Hoy (${formatDate(new Date())})
                            </div>
                            <small style="color: #888; font-size: 0.8rem; margin-top: 0.5rem; display: block;">La membresÃ­a se activa inmediatamente.</small>
                        </div>

                        <div id="membership-preview" style="margin-top: 1.5rem; padding: 1rem; background: linear-gradient(135deg, rgba(196, 163, 90, 0.1), rgba(196, 163, 90, 0.05)); border-radius: 8px; border: 1px solid rgba(196, 163, 90, 0.2); display: none;">
                            <p style="color: var(--gold); font-weight: 600; margin-bottom: 0.75rem;"><i class="fas fa-receipt" style="margin-right: 8px;"></i>Resumen:</p>
                            <p id="preview-details" style="line-height: 1.8; color: #ccc;"></p>
                        </div>
                    </form>
                `;

                const footer = `
                    <button class="btn btn-secondary" onclick="activateMembershipModal.close()">Cancelar</button>
                    <button class="btn btn-primary" onclick="activateMembership()"><i class="fas fa-crown" style="margin-right: 8px;"></i>Activar MembresÃ­a</button>
                `;

                window.activateMembershipModal = showModal('activateMembershipModal', 'Activar MembresÃ­a', content, footer);

                if (preSelectedTypeId) {
                    const typeSelect = document.getElementById('membership-type');
                    typeSelect.value = preSelectedTypeId;
                    updateMembershipPreview();
                }

                // Initialize prefix if empty selection (or just trigger update)
                updateMembershipPreview();

            } catch (error) {
                console.error('Error loading data:', error);
                showToast('Error al cargar los datos', 'error');
            }
        }

        function getPrefixForType(name) {
            const lower = name.toLowerCase();
            if (lower.includes('black')) return 'BC';
            if (lower.includes('neocapilar')) return 'GN';
            if (lower.includes('corte')) return 'GC';
            if (lower.includes('golden')) return 'GC'; // Fallback for other golden
            return 'MB';
        }

        function updateMembershipPreview() {
            const typeSelect = document.getElementById('membership-type');
            const startDate = document.getElementById('membership-start-date') ? document.getElementById('membership-start-date').value : new Date().toISOString().split('T')[0];
            const preview = document.getElementById('membership-preview');
            const details = document.getElementById('preview-details');

            if (!typeSelect.value) {
                preview.style.display = 'none';
                return;
            }

            const option = typeSelect.options[typeSelect.selectedIndex];
            const price = option.dataset.price;
            const services = option.dataset.services;
            const typeName = option.textContent.split(' - ')[0];

            const start = new Date(startDate);
            let endDate = 'Sin vencimiento (Lifetime)';

            if (typeName.toLowerCase() !== 'black') {
                const end = new Date(start);
                end.setMonth(end.getMonth() + 1);
                endDate = formatDate(end.toISOString().split('T')[0]);
            }

            // Update Prefix
            const prefix = getPrefixForType(typeName);
            const prefixSpan = document.getElementById('folio-prefix');
            if (prefixSpan) prefixSpan.textContent = prefix;

            details.innerHTML = `
                Plan: ${typeName}<br>
                Precio: ${formatCurrency(price)}<br>
                Servicios: ${services > 0 ? services : 'Ilimitados'}<br>
                Transferible: ${option.dataset.transferable === 'true' ? 'SÃ­' : 'No'}<br>
                Inicio: ${formatDate(startDate)}<br>
                Vencimiento: ${endDate}
            `;

            preview.style.display = 'block';
        }

        async function activateMembership() {
            const form = document.getElementById('membership-form');
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }

            // Get client info from selected option
            const clientSelect = document.getElementById('membership-client');
            const selectedOption = clientSelect.options[clientSelect.selectedIndex];
            const clientPhone = selectedOption.dataset.phone;
            const clientName = selectedOption.dataset.name;

            const membershipData = {
                client_id: parseInt(clientSelect.value),
                membership_type_id: parseInt(document.getElementById('membership-type').value),
                payment_method: document.getElementById('payment-method').value,
                folio_number: document.getElementById('folio-prefix').textContent + document.getElementById('membership-folio').value
            };

            // Get plan name for message
            const typeSelect = document.getElementById('membership-type');
            const planName = typeSelect.options[typeSelect.selectedIndex].textContent.split(' - ')[0];

            try {
                // AdminAPI.createMembership uses POST /api/admin/memberships
                const response = await AdminAPI.createMembership(membershipData);

                // Show Success Modal with Share Link
                window.activateMembershipModal.close();

                const uuid = response.uuid;
                const shareLink = `https://braco-s-barberia-production.up.railway.app/tarjeta.html?id=${uuid}`;

                // Clean phone number
                const cleanPhone = clientPhone.replace(/\D/g, '');

                // Build WhatsApp message with client name and plan
                const whatsappMsg = `Â¡Hola *${clientName}*! ðŸŽ‰\n\nÂ¡Felicidades! Tu membresÃ­a *${planName}* de Braco's BarberÃ­a ha sido activada con Ã©xito. ðŸ‘‘\n\nAquÃ­ estÃ¡ tu *Tarjeta Digital*:\n${shareLink}\n\nâœ¨ GuÃ¡rdala y presÃ©ntala en tu prÃ³xima visita.\n\nÂ¡Gracias por confiar en Braco's! ðŸ’ˆ`;
                const whatsappUrl = `https://wa.me/52${cleanPhone}?text=${encodeURIComponent(whatsappMsg)}`;

                const successContent = `
                    <div style="text-align: center; padding: 1rem;">
                        <div style="background: linear-gradient(135deg, rgba(76, 175, 80, 0.2), rgba(76, 175, 80, 0.1)); width: 80px; height: 80px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 1.5rem; border: 2px solid rgba(76, 175, 80, 0.3);">
                            <i class="fas fa-crown" style="font-size: 2.5rem; color: #4CAF50;"></i>
                        </div>
                        <h3 style="color: var(--gold); margin-bottom: 0.5rem; font-size: 1.5rem;">Â¡MembresÃ­a Activada!</h3>
                        <p style="color: #ccc; margin-bottom: 0.5rem;">Cliente: <strong>${clientName}</strong></p>
                        <p style="color: var(--gold); margin-bottom: 1.5rem;">Plan: <strong>${planName}</strong></p>

                        <div style="background: rgba(255,255,255,0.05); padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem; border: 1px solid rgba(196, 163, 90, 0.2);">
                            <p style="font-size: 0.8rem; color: #888; margin-bottom: 0.5rem;">ENLACE DE TARJETA DIGITAL</p>
                            <input type="text" value="${shareLink}" readonly
                                style="width: 100%; background: rgba(0,0,0,0.3); border: 1px solid rgba(196, 163, 90, 0.3); color: #fff; padding: 0.75rem; text-align: center; font-size: 0.85rem; border-radius: 6px;"
                                onclick="this.select()">
                        </div>

                        <div style="display: flex; gap: 1rem; justify-content: center; flex-wrap: wrap;">
                            <a href="${whatsappUrl}" target="_blank" class="btn" style="background: #25D366; border: none; color: white; padding: 0.75rem 1.5rem; border-radius: 6px; font-weight: 600; display: inline-flex; align-items: center; gap: 8px; text-decoration: none;">
                                <i class="fab fa-whatsapp" style="font-size: 1.2rem;"></i> Enviar por WhatsApp
                            </a>
                            <button onclick="copyToClipboard('${shareLink}')" class="btn btn-secondary" style="padding: 0.75rem 1.5rem;">
                                <i class="fas fa-copy"></i> Copiar Link
                            </button>
                        </div>

                        <p style="font-size: 0.8rem; color: #666; margin-top: 1.5rem;">
                            <i class="fas fa-info-circle"></i> El cliente recibirÃ¡ su tarjeta digital por WhatsApp
                        </p>
                    </div>
                `;

                window.successModal = showModal('successModal', 'âœ… MembresÃ­a Activada', successContent, '<button class="btn btn-primary" onclick="window.successModal.close()">Cerrar</button>');

                // Auto-open WhatsApp to send the membership card
                window.open(whatsappUrl, '_blank');

                loadMemberships();
            } catch (error) {
                console.error('Error activating membership:', error);
                showToast(error.message || 'Error al activar la membresÃ­a', 'error');
            }
        }

        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                showToast('Enlace copiado al portapapeles', 'success');
            }).catch(console.error);
        }

        async function viewMembershipDetail(id) {
            try {
                const membership = await AdminAPI.getMembership(id);

                const content = `
                    <div style="line-height: 1.8;">
                        <p><strong>Cliente:</strong> ${membership.client_name}</p>
                        <p><strong>TelÃ©fono:</strong> ${formatPhone(membership.client_phone)}</p>
                        <p><strong>Plan:</strong> ${membership.type_name}</p>
                        <p><strong>Folio:</strong> ${membership.folio_number || 'N/A'}</p>
                        <p><strong>Precio:</strong> ${formatCurrency(membership.type_price)}</p>
                        <p><strong>Fecha de Inicio:</strong> ${formatDate(membership.start_date)}</p>
                        <p><strong>Fecha de Vencimiento:</strong> ${membership.end_date ? formatDate(membership.end_date) : 'Sin vencimiento (Lifetime)'}</p>
                        <p><strong>Servicios Restantes:</strong> ${membership.type_name === 'black' ? 'Ilimitados' : `${membership.remaining_services || 0}`}</p>
                        <p><strong>Estado:</strong> 
                            ${membership.status === 'active'
                        ? '<span class="badge active">Activa</span>'
                        : '<span class="badge inactive">Cancelada</span>'}
                        </p>
                        ${membership.payment_history && membership.payment_history.length > 0 ? `
                            <div style="margin-top: 1.5rem; padding-top: 1rem; border-top: 1px solid rgba(196, 163, 90, 0.1);">
                                <p><strong>Historial de Pagos:</strong></p>
                                ${membership.payment_history.map(p => `
                                    <div style="padding: 0.5rem 0;">
                                        ${formatDate(p.payment_date)} - ${formatCurrency(p.amount)} <small>(${p.payment_method})</small>
                                    </div>
                                `).join('')}
                            </div>
                        ` : ''}

                        <div style="margin-top: 1.5rem; padding-top: 1rem; border-top: 1px solid rgba(196, 163, 90, 0.1);">
                            <p><strong>Historial de Uso (Sellos):</strong></p>
                            ${membership.usage_history && membership.usage_history.length > 0 ?
                        membership.usage_history.map(u => `
                                    <div style="padding: 0.8rem; margin-bottom: 0.5rem; background: rgba(76, 175, 80, 0.1); border-left: 3px solid #4CAF50; border-radius: 4px;">
                                        <div style="font-weight: 500; color: #4CAF50;">âœ… Servicio Completado</div>
                                        <div style="font-size: 0.9em;">${u.service_name || 'Servicio'}</div>
                                        <div style="font-size: 0.8em; color: #666;">${formatDate(u.used_at)}</div>
                                    </div>
                                `).join('')
                        : '<p style="color: #999; font-style: italic;">Sin uso registrado</p>'
                    }
                            ${(membership.total_services - membership.used_services) > 0 ?
                        ` <div style="padding: 0.8rem; margin-top: 0.5rem; background: rgba(33, 150, 243, 0.1); border-left: 3px solid #2196F3; border-radius: 4px;">
                                    <div style="font-weight: 500; color: #2196F3;">ðŸ”µ Servicios Restantes</div>
                                    <div style="font-size: 0.9em;">${membership.total_services - membership.used_services} Disponibles</div>
                                  </div>`
                        : ''
                    }
                        </div>
                    </div>
                `;

                const footer = `
                    <button class="btn btn-secondary" onclick="membershipDetailModal.close()">Cerrar</button>
                `;

                window.membershipDetailModal = showModal('membershipDetailModal', 'Detalles de MembresÃ­a', content, footer);

            } catch (error) {
                console.error('Error loading membership details:', error);
                showToast('Error al cargar los detalles', 'error');
            }
        }

        function cancelMembership(id) {
            const membership = allMemberships.find(m => m.id === id);
            if (!membership) return;

            showConfirm(
                'Confirmar CancelaciÃ³n',
                `Â¿EstÃ¡s seguro de cancelar la membresÃ­a de <strong>${membership.client_name}</strong>? Esta acciÃ³n no se puede deshacer.`,
                async () => {
                    try {
                        await AdminAPI.cancelMembership(id);
                        showToast('MembresÃ­a cancelada correctamente', 'success');
                        loadMemberships();
                    } catch (error) {
                        console.error('Error canceling membership:', error);
                        showToast(error.message || 'Error al cancelar la membresÃ­a', 'error');
                    }
                }
            );
        }

        async function exportMemberships() {
            try {
                showToast('Generando reporte detallado...', 'info');

                const response = await api.get('/admin/memberships/export/data');

                if (!response || response.length === 0) {
                    showToast('No hay datos para exportar', 'warning');
                    return;
                }

                const exportData = response.map(m => ({
                    'Folio': m.folio || 'S/N',
                    'Cliente': m.client_name,
                    'Plan': m.plan_name,
                    'Precio': formatCurrency(m.price),
                    'Estado': m.status === 'active' ? 'Activa' : 'Cancelada',
                    'Inicio': formatDate(m.start_date),
                    'Vencimiento': m.end_date ? formatDate(m.end_date) : 'N/A',
                    'Servicios Restantes': m.remaining_services,
                    'Servicio Usado': m.used_service || 'Sin uso',
                    'Fecha Uso': m.usage_date ? formatDateTime(m.usage_date) : '-',
                    'Valor Uso': m.usage_value ? formatCurrency(m.usage_value) : '-',
                    'Sellos': m.stamps_used || '-'
                }));

                exportToExcel(exportData, `Membresias_Detalle_${new Date().toISOString().split('T')[0]}`);

            } catch (error) {
                console.error('Export error:', error);
                showToast('Error al exportar: ' + error.message, 'error');
            }
        }

        // Initial load
        loadMemberships();
    </script>

    <!-- Mobile Menu Script -->
    <!-- Mobile Menu Script Removed -->
    <script src="js/sidebar.js"></script>
</body>

</html>