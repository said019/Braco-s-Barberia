<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Membres√≠as | Admin</title>
    <link
        href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@400;500;600;700&family=Montserrat:wght@300;400;500;600&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="stylesheet" href="css/admin.css">
</head>

<body>
    <div class="admin-layout">
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <img src="../assets/logo.png" alt="Logo"
                    style="height: 60px; margin-bottom: 10px; display: block; margin: 0 auto 10px;">
                <p class="sidebar-subtitle">Administraci√≥n</p>
            </div>

            <nav class="sidebar-nav">
                <div class="nav-section">
                    <span class="nav-section-title">Principal</span>
                    <a href="index.html" class="nav-item">
                        <span class="nav-icon"><i class="fas fa-chart-line"></i></span>
                        <span>Dashboard</span>
                    </a>
                    <a href="calendario.html" class="nav-item">
                        <span class="nav-icon"><i class="far fa-calendar-alt"></i></span>
                        <span>Calendario</span>
                    </a>
                    <a href="citas.html" class="nav-item">
                        <span class="nav-icon"><i class="fas fa-scissors"></i></span>
                        <span>Citas</span>
                        <span class="badge" id="nav-badge-citas">0</span>
                    </a>
                </div>

                <div class="nav-section">
                    <span class="nav-section-title">Gesti√≥n</span>
                    <a href="clientes.html" class="nav-item">
                        <span class="nav-icon"><i class="fas fa-users"></i></span>
                        <span>Clientes</span>
                    </a>
                    <a href="membresias.html" class="nav-item active">
                        <span class="nav-icon"><i class="fas fa-crown"></i></span>
                        <span>Membres√≠as</span>
                    </a>
                    <a href="servicios.html" class="nav-item">
                        <span class="nav-icon"><i class="fas fa-cut"></i></span>
                        <span>Servicios</span>
                    </a>
                    <a href="productos.html" class="nav-item">
                        <span class="nav-icon"><i class="fas fa-pump-soap"></i></span>
                        <span>Productos</span>
                    </a>
                </div>

                <div class="nav-section">
                    <span class="nav-section-title">Reportes</span>
                    <a href="reportes.html" class="nav-item">
                        <span class="nav-icon"><i class="fas fa-file-invoice-dollar"></i></span>
                        <span>Ventas</span>
                    </a>
                </div>

                <div class="nav-section">
                    <span class="nav-section-title">Sistema</span>
                    <a href="configuracion.html" class="nav-item">
                        <span class="nav-icon"><i class="fas fa-cog"></i></span>
                        <span>Configuraci√≥n</span>
                    </a>
                </div>
            </nav>

            <div class="sidebar-footer">
                <div class="admin-profile">
                    <div class="admin-avatar" id="admin-avatar">A</div>
                    <div class="admin-info">
                        <div class="admin-name" id="admin-name">Admin</div>
                        <div class="admin-role" id="admin-role">Administrador</div>
                    </div>
                </div>
                <button class="btn-logout" onclick="logout()">Cerrar Sesi√≥n</button>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <header class="main-header">
                <div class="header-title">
                    <h2>Gesti√≥n de Membres√≠as</h2>
                    <p class="header-date">Administra planes y suscripciones</p>
                </div>
                <div class="header-actions">
                    <button class="btn btn-secondary" onclick="exportMemberships()" style="margin-right: 10px;">
                        <i class="fas fa-file-export"></i> Exportar
                    </button>
                    <button class="btn btn-primary" onclick="openActivateMembershipModal()">+ Activar Membres√≠a</button>
                </div>
            </header>

            <!-- Catalog Section -->
            <section class="membership-catalog-section">
                <div class="section-header">
                    <h3>Cat√°logo de Membres√≠as</h3>
                    <p class="text-muted">Planes disponibles para venta</p>
                </div>
                <div class="membership-cards-grid">
                    <!-- Golden Card Corte -->
                    <div class="membership-card-display golden">
                        <div class="card-header-display">
                            <span class="card-icon"><i class="fas fa-cut"></i></span>
                            <h4>Golden Card Corte</h4>
                        </div>
                        <div class="card-price-display">
                            $1,500 <span class="currency">MXN</span>
                        </div>
                        <ul class="card-features-display">
                            <li><i class="fas fa-check"></i> 6 Servicios Totales</li>
                            <li><i class="fas fa-check"></i> Corte de Cabello</li>
                            <li><i class="fas fa-check"></i> Ritual de Barba</li>
                            <li><i class="fas fa-check"></i> Servicio D√∫o</li>
                            <li class="restricted"><i class="fas fa-user-lock"></i> Intransferible</li>
                        </ul>
                        <button class="btn btn-primary btn-sm btn-block" onclick="openActivateMembershipModal(8)">Vender
                            Plan</button>
                    </div>

                    <!-- Golden Card NeoCapilar -->
                    <div class="membership-card-display golden">
                        <div class="card-header-display">
                            <span class="card-icon"><i class="fas fa-spa"></i></span>
                            <h4>Golden NeoCapilar</h4>
                        </div>
                        <div class="card-price-display">
                            $3,850 <span class="currency">MXN</span>
                        </div>
                        <ul class="card-features-display">
                            <li><i class="fas fa-check"></i> 8 Servicios Totales (Paga 7)</li>
                            <li><i class="fas fa-check"></i> Terapia Integral Capilar (TIC)</li>
                            <li><i class="fas fa-check"></i> Salud y Prevenci√≥n</li>
                            <li class="restricted"><i class="fas fa-user-lock"></i> Intransferible</li>
                        </ul>
                        <button class="btn btn-primary btn-sm btn-block" onclick="openActivateMembershipModal(9)">Vender
                            Plan</button>
                    </div>

                    <!-- Black Card -->
                    <div class="membership-card-display black">
                        <div class="card-header-display">
                            <span class="card-icon"><i class="fas fa-crown"></i></span>
                            <h4>Black Card</h4>
                        </div>
                        <div class="card-price-display">
                            $3,300 <span class="currency">MXN</span>
                        </div>
                        <ul class="card-features-display">
                            <li><i class="fas fa-check"></i> 12 Servicios Totales (Paga 11)</li>
                            <li><i class="fas fa-check"></i> Cortes, Barba, Mascarillas</li>
                            <li><i class="fas fa-check"></i> Manicura y Pedicura</li>
                            <li class="highlight"><i class="fas fa-share-alt"></i> Transferible</li>
                        </ul>
                        <button class="btn btn-primary btn-sm btn-block"
                            onclick="openActivateMembershipModal(10)">Vender Plan</button>
                    </div>
                </div>
            </section>

            <!-- Stats -->
            <section class="stats-grid">
                <div class="stat-card">
                    <div class="stat-icon"><i class="fas fa-crown"></i></div>
                    <div class="stat-content">
                        <span class="stat-value" id="stat-active">0</span>
                        <span class="stat-label">Activas</span>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon"><i class="fas fa-exclamation-triangle"></i></div>
                    <div class="stat-content">
                        <span class="stat-value" id="stat-expiring">0</span>
                        <span class="stat-label">Por Vencer (30 d√≠as)</span>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon"><i class="fas fa-dollar-sign"></i></div>
                    <div class="stat-content">
                        <span class="stat-value" id="stat-revenue">$0</span>
                        <span class="stat-label">Ingresos Mensuales</span>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">üëë</div>
                    <div class="stat-content">
                        <span class="stat-value" id="stat-lifetime">0</span>
                        <span class="stat-label">Lifetime (Black)</span>
                    </div>
                </div>
            </section>

            <!-- Filters -->
            <section class="content-section">
                <div class="filters-bar">
                    <input type="text" id="search-memberships" class="search-input" placeholder="Buscar por cliente...">

                    <select id="filter-status" class="search-input" style="width: auto;">
                        <option value="">Todos los estados</option>
                        <option value="active">Activas</option>
                        <option value="expiring">Por vencer</option>
                        <option value="cancelled">Canceladas</option>
                    </select>

                    <select id="filter-type" class="search-input" style="width: auto;">
                        <option value="">Todos los planes</option>
                        <option value="gold">Gold</option>
                        <option value="platinum">Platinum</option>
                        <option value="black">Black</option>
                    </select>

                    <button class="btn btn-secondary" onclick="exportMemberships()">üì• Exportar</button>
                </div>
            </section>

            <!-- Memberships Table -->
            <section class="content-section">
                <div class="section-header">
                    <h3>Membres√≠as Activas</h3>
                </div>

                <div id="memberships-container">
                    <div class="loading">
                        <div class="loading-spinner"></div>
                        <p>Cargando membres√≠as...</p>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <script src="../js/admin.js"></script>
    <script>
        checkAuth();

        let allMemberships = [];
        let filteredMemberships = [];
        let membershipTypes = [];

        // Event listeners
        document.getElementById('search-memberships').addEventListener('input', debounce(applyFilters, 300));
        document.getElementById('filter-status').addEventListener('change', applyFilters);
        document.getElementById('filter-type').addEventListener('change', applyFilters);

        // Load data
        async function loadMemberships() {
            try {
                const data = await AdminAPI.getMemberships();
                allMemberships = data.memberships || [];

                // Update stats
                const active = allMemberships.filter(m => m.status === 'active').length;
                document.getElementById('stat-active').textContent = active;

                const thirtyDaysFromNow = new Date();
                thirtyDaysFromNow.setDate(thirtyDaysFromNow.getDate() + 30);
                const expiring = allMemberships.filter(m => {
                    if (m.status !== 'active' || !m.end_date) return false;
                    const endDate = new Date(m.end_date);
                    return endDate <= thirtyDaysFromNow;
                }).length;
                document.getElementById('stat-expiring').textContent = expiring;

                const monthlyRevenue = allMemberships
                    .filter(m => m.status === 'active' && m.type_name !== 'black')
                    .reduce((sum, m) => sum + parseFloat(m.type_price || 0), 0);
                document.getElementById('stat-revenue').textContent = formatCurrency(monthlyRevenue);

                const lifetime = allMemberships.filter(m =>
                    m.status === 'active' && m.type_name === 'black'
                ).length;
                document.getElementById('stat-lifetime').textContent = lifetime;

                applyFilters();

            } catch (error) {
                console.error('Error loading memberships:', error);
                showToast('Error al cargar las membres√≠as', 'error');
            }
        }

        function applyFilters() {
            const searchTerm = document.getElementById('search-memberships').value.toLowerCase();
            const statusFilter = document.getElementById('filter-status').value;
            const typeFilter = document.getElementById('filter-type').value;

            filteredMemberships = allMemberships.filter(membership => {
                // Search filter
                if (searchTerm) {
                    const searchText = membership.client_name.toLowerCase();
                    if (!searchText.includes(searchTerm)) return false;
                }

                // Status filter
                if (statusFilter === 'active' && membership.status !== 'active') return false;
                if (statusFilter === 'cancelled' && membership.status !== 'cancelled') return false;
                if (statusFilter === 'expiring') {
                    if (membership.status !== 'active' || !membership.end_date) return false;
                    const thirtyDaysFromNow = new Date();
                    thirtyDaysFromNow.setDate(thirtyDaysFromNow.getDate() + 30);
                    const endDate = new Date(membership.end_date);
                    if (endDate > thirtyDaysFromNow) return false;
                }

                // Type filter
                if (typeFilter && membership.type_name !== typeFilter) return false;

                return true;
            });

            renderMemberships();
        }

        function renderMemberships() {
            const container = document.getElementById('memberships-container');

            if (filteredMemberships.length === 0) {
                container.innerHTML = '<p class="empty-message">No se encontraron membres√≠as</p>';
                return;
            }

            const columns = [
                {
                    field: 'client_name',
                    label: 'Cliente',
                    format: (value, row) => `
                        <div>
                            <div class="font-medium">${value}</div>
                            <div class="text-sm text-muted">${formatPhone(row.client_phone)}</div>
                        </div>
                    `
                },
                {
                    field: 'folio_number',
                    label: 'Folio',
                    format: (value) => value ? `<span class="badge" style="background: rgba(196, 163, 90, 0.1); color: var(--primary-gold);">${value}</span>` : '-'
                },
                {
                    field: 'membership_type',
                    label: 'Plan',
                    format: (value) => `<span class="font-medium text-gold">${value}</span>`
                },
                {
                    field: 'activation_date',
                    label: 'Inicio',
                    format: (value) => formatDate(value)
                },
                {
                    field: 'expiration_date',
                    label: 'Vencimiento',
                    format: (value, row) => {
                        if (!value) return '<span class="text-success">Lifetime</span>';

                        const date = new Date(value);
                        const today = new Date();
                        const diffTime = date - today;
                        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

                        let badge = '';
                        if (diffDays < 0) {
                            badge = ' <span class="badge inactive">Vencida</span>';
                        } else if (diffDays <= 7) {
                            badge = ' <span class="badge expiring">Por vencer</span>';
                        }
                        return formatDate(value) + badge;
                    }
                },
                {
                    field: 'remaining_services',
                    label: 'Servicios',
                    format: (value, row) => {
                        // Check for unlimited (e.g. Black) based on type or value
                        if (row.membership_type.toLowerCase() === 'black') return '‚ôæÔ∏è';
                        return `${value !== undefined ? value : '?'} est.`;
                    }
                },
                {
                    field: 'status',
                    label: 'Estado',
                    format: (value) => {
                        const badges = {
                            active: '<span class="badge active">Activa</span>',
                            cancelled: '<span class="badge inactive">Cancelada</span>'
                        };
                        return badges[value] || value;
                    }
                },
                {
                    field: 'id',
                    label: 'Acciones',
                    format: (value, row) => `
                        <div class="actions">
                            <button class="btn-icon" onclick="viewMembershipDetail(${value})" title="Ver detalles"><i class="fas fa-eye"></i></button>
                            ${row.status === 'active' ?
                            `<button class="btn-icon" onclick="cancelMembership(${value})" title="Cancelar"><i class="fas fa-ban"></i></button>`
                            : ''}
                        </div>
                    `
                }
            ];

            container.innerHTML = createTable(filteredMemberships, columns);
        }

        async function openActivateMembershipModal(preSelectedTypeId = null) {
            // Load clients and membership types for dropdown
            try {
                // Use fetchWithAuth for secured types endpoint
                const [clientsData, typesData] = await Promise.all([
                    AdminAPI.getClients(),
                    fetchWithAuth('/admin/membership-types')
                ]);

                const clients = clientsData.clients || [];
                membershipTypes = typesData.types || [];

                const content = `
                    <form id="membership-form" class="admin-form">
                        <div class="form-group">
                            <label for="membership-client">Cliente *</label>
                            <select id="membership-client" required>
                                <option value="">Selecciona un cliente</option>
                                ${clients.map(c => `
                                    <option value="${c.id}">${c.name} - ${formatPhone(c.phone)}</option>
                                `).join('')}
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="membership-type">Plan *</label>
                            <select id="membership-type" required onchange="updateMembershipPreview()">
                                <option value="">Selecciona un plan</option>
                                ${membershipTypes.map(t => `
                                    <option value="${t.id}" data-price="${t.price}" data-services="${t.total_services || 0}" data-transferable="${t.is_transferable}">
                                        ${t.name} - ${formatCurrency(t.price)}
                                    </option>
                                `).join('')}
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="membership-folio">Folio *</label>
                            <div style="display: flex; gap: 10px; align-items: center;">
                                <span id="folio-prefix" style="background: rgba(255,255,255,0.1); padding: 0.8rem; border-radius: 4px; color: var(--gold); font-weight: bold; min-width: 50px; text-align: center;">-</span>
                                <input type="number" id="membership-folio" required placeholder="N√∫mero (ej: 1)" class="form-control" style="flex: 1;">
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="payment-method">M√©todo de Pago *</label>
                            <select id="payment-method" required>
                                <option value="efectivo">Efectivo</option>
                                <option value="tarjeta">Tarjeta</option>
                                <option value="transferencia">Transferencia</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label>Fecha de Inicio</label>
                            <input type="text" value="Hoy (${formatDate(new Date())})" disabled class="form-control" style="opacity: 0.7;">
                            <small class="text-muted">La membres√≠a se activa inmediatamente.</small>
                        </div>
                        
                        <div id="membership-preview" style="margin-top: 1rem; padding: 1rem; background: rgba(196, 163, 90, 0.1); display: none;">
                            <p><strong>Resumen:</strong></p>
                            <p id="preview-details"></p>
                        </div>
                    </form>
                `;

                const footer = `
                    <button class="btn btn-secondary" onclick="activateMembershipModal.close()">Cancelar</button>
                    <button class="btn btn-primary" onclick="activateMembership()">Activar Membres√≠a</button>
                `;

                window.activateMembershipModal = showModal('activateMembershipModal', 'Activar Membres√≠a', content, footer);

                if (preSelectedTypeId) {
                    const typeSelect = document.getElementById('membership-type');
                    typeSelect.value = preSelectedTypeId;
                    updateMembershipPreview();
                }

                // Initialize prefix if empty selection (or just trigger update)
                updateMembershipPreview();

            } catch (error) {
                console.error('Error loading data:', error);
                showToast('Error al cargar los datos', 'error');
            }
        }

        function getPrefixForType(name) {
            const lower = name.toLowerCase();
            if (lower.includes('black')) return 'BC';
            if (lower.includes('neocapilar')) return 'GN';
            if (lower.includes('corte')) return 'GC';
            if (lower.includes('golden')) return 'GC'; // Fallback for other golden
            return 'MB';
        }

        function updateMembershipPreview() {
            const typeSelect = document.getElementById('membership-type');
            const startDate = document.getElementById('membership-start-date') ? document.getElementById('membership-start-date').value : new Date().toISOString().split('T')[0];
            const preview = document.getElementById('membership-preview');
            const details = document.getElementById('preview-details');

            if (!typeSelect.value) {
                preview.style.display = 'none';
                return;
            }

            const option = typeSelect.options[typeSelect.selectedIndex];
            const price = option.dataset.price;
            const services = option.dataset.services;
            const typeName = option.textContent.split(' - ')[0];

            const start = new Date(startDate);
            let endDate = 'Sin vencimiento (Lifetime)';

            if (typeName.toLowerCase() !== 'black') {
                const end = new Date(start);
                end.setMonth(end.getMonth() + 1);
                endDate = formatDate(end.toISOString().split('T')[0]);
            }

            // Update Prefix
            const prefix = getPrefixForType(typeName);
            const prefixSpan = document.getElementById('folio-prefix');
            if (prefixSpan) prefixSpan.textContent = prefix;

            details.innerHTML = `
                Plan: ${typeName}<br>
                Precio: ${formatCurrency(price)}<br>
                Servicios: ${services > 0 ? services : 'Ilimitados'}<br>
                Transferible: ${option.dataset.transferable === 'true' ? 'S√≠' : 'No'}<br>
                Inicio: ${formatDate(startDate)}<br>
                Vencimiento: ${endDate}
            `;

            preview.style.display = 'block';
        }

        async function activateMembership() {
            const form = document.getElementById('membership-form');
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }

            const membershipData = {
                client_id: parseInt(document.getElementById('membership-client').value),
                membership_type_id: parseInt(document.getElementById('membership-type').value),
                payment_method: document.getElementById('payment-method').value,
                folio_number: document.getElementById('folio-prefix').textContent + document.getElementById('membership-folio').value
            };

            try {
                // AdminAPI.createMembership uses POST /api/admin/memberships
                const response = await AdminAPI.createMembership(membershipData);

                // Show Success Modal with Share Link
                window.activateMembershipModal.close();

                const uuid = response.uuid;
                const shareLink = `${window.location.origin}/tarjeta.html?id=${uuid}`;
                const whatsappMsg = `¬°Hola! Aqu√≠ tienes tu Membres√≠a Digital de Braco's Barber√≠a: ${shareLink}`;
                const whatsappUrl = `https://wa.me/?text=${encodeURIComponent(whatsappMsg)}`;

                const successContent = `
                    <div style="text-align: center; padding: 1rem;">
                        <div style="background: rgba(76, 175, 80, 0.1); width: 60px; height: 60px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 1.5rem;">
                            <i class="fas fa-check" style="font-size: 2rem; color: #4CAF50;"></i>
                        </div>
                        <h3 style="color: var(--gold); margin-bottom: 0.5rem;">¬°Membres√≠a Activada!</h3>
                        <p style="color: #ccc; margin-bottom: 1.5rem;">La membres√≠a se ha registrado correctamente.</p>
                        
                        <div style="background: rgba(255,255,255,0.05); padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem;">
                            <p style="font-size: 0.8rem; color: #888; margin-bottom: 0.5rem;">ENLACE DIGITAL</p>
                            <input type="text" value="${shareLink}" readonly 
                                style="width: 100%; background: transparent; border: 1px solid #444; color: #fff; padding: 0.5rem; text-align: center; font-size: 0.9rem; border-radius: 4px;"
                                onclick="this.select()">
                        </div>

                        <div style="display: flex; gap: 1rem; justify-content: center;">
                            <a href="${whatsappUrl}" target="_blank" class="btn btn-success" style="background: #25D366; border-color: #25D366; color: white;">
                                <i class="fab fa-whatsapp"></i> Enviar por WhatsApp
                            </a>
                            <button onclick="copyToClipboard('${shareLink}')" class="btn btn-secondary">
                                <i class="fas fa-copy"></i> Copiar
                            </button>
                        </div>
                    </div>
                `;

                window.successModal = showModal('successModal', 'Operaci√≥n Exitosa', successContent, '<button class="btn btn-primary" onclick="window.successModal.close()">Cerrar</button>');

                loadMemberships();
            } catch (error) {
                console.error('Error activating membership:', error);
                showToast(error.message || 'Error al activar la membres√≠a', 'error');
            }
        }

        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                showToast('Enlace copiado al portapapeles', 'success');
            }).catch(console.error);
        }

        async function viewMembershipDetail(id) {
            try {
                const membership = await AdminAPI.getMembership(id);

                const content = `
                    <div style="line-height: 1.8;">
                        <p><strong>Cliente:</strong> ${membership.client_name}</p>
                        <p><strong>Tel√©fono:</strong> ${formatPhone(membership.client_phone)}</p>
                        <p><strong>Plan:</strong> ${membership.type_name}</p>
                        <p><strong>Folio:</strong> ${membership.folio_number || 'N/A'}</p>
                        <p><strong>Precio:</strong> ${formatCurrency(membership.type_price)}</p>
                        <p><strong>Fecha de Inicio:</strong> ${formatDate(membership.start_date)}</p>
                        <p><strong>Fecha de Vencimiento:</strong> ${membership.end_date ? formatDate(membership.end_date) : 'Sin vencimiento (Lifetime)'}</p>
                        <p><strong>Servicios Restantes:</strong> ${membership.type_name === 'black' ? 'Ilimitados' : `${membership.remaining_services || 0}`}</p>
                        <p><strong>Estado:</strong> 
                            ${membership.status === 'active'
                        ? '<span class="badge active">Activa</span>'
                        : '<span class="badge inactive">Cancelada</span>'}
                        </p>
                        ${membership.payment_history && membership.payment_history.length > 0 ? `
                            <div style="margin-top: 1.5rem; padding-top: 1rem; border-top: 1px solid rgba(196, 163, 90, 0.1);">
                                <p><strong>Historial de Pagos:</strong></p>
                                ${membership.payment_history.map(p => `
                                    <div style="padding: 0.5rem 0;">
                                        ${formatDate(p.payment_date)} - ${formatCurrency(p.amount)} <small>(${p.payment_method})</small>
                                    </div>
                                `).join('')}
                            </div>
                        ` : ''}

                        <div style="margin-top: 1.5rem; padding-top: 1rem; border-top: 1px solid rgba(196, 163, 90, 0.1);">
                            <p><strong>Historial de Uso (Sellos):</strong></p>
                            ${membership.usage_history && membership.usage_history.length > 0 ?
                        membership.usage_history.map(u => `
                                    <div style="padding: 0.8rem; margin-bottom: 0.5rem; background: rgba(76, 175, 80, 0.1); border-left: 3px solid #4CAF50; border-radius: 4px;">
                                        <div style="font-weight: 500; color: #4CAF50;">‚úÖ Servicio Completado</div>
                                        <div style="font-size: 0.9em;">${u.service_name || 'Servicio'}</div>
                                        <div style="font-size: 0.8em; color: #666;">${formatDate(u.used_at)}</div>
                                    </div>
                                `).join('')
                        : '<p style="color: #999; font-style: italic;">Sin uso registrado</p>'
                    }
                            ${(membership.total_services - membership.used_services) > 0 ?
                        ` <div style="padding: 0.8rem; margin-top: 0.5rem; background: rgba(33, 150, 243, 0.1); border-left: 3px solid #2196F3; border-radius: 4px;">
                                    <div style="font-weight: 500; color: #2196F3;">üîµ Servicios Restantes</div>
                                    <div style="font-size: 0.9em;">${membership.total_services - membership.used_services} Disponibles</div>
                                  </div>`
                        : ''
                    }
                        </div>
                    </div>
                `;

                const footer = `
                    <button class="btn btn-secondary" onclick="membershipDetailModal.close()">Cerrar</button>
                `;

                window.membershipDetailModal = showModal('membershipDetailModal', 'Detalles de Membres√≠a', content, footer);

            } catch (error) {
                console.error('Error loading membership details:', error);
                showToast('Error al cargar los detalles', 'error');
            }
        }

        function cancelMembership(id) {
            const membership = allMemberships.find(m => m.id === id);
            if (!membership) return;

            showConfirm(
                'Confirmar Cancelaci√≥n',
                `¬øEst√°s seguro de cancelar la membres√≠a de <strong>${membership.client_name}</strong>? Esta acci√≥n no se puede deshacer.`,
                async () => {
                    try {
                        await AdminAPI.cancelMembership(id);
                        showToast('Membres√≠a cancelada correctamente', 'success');
                        loadMemberships();
                    } catch (error) {
                        console.error('Error canceling membership:', error);
                        showToast(error.message || 'Error al cancelar la membres√≠a', 'error');
                    }
                }
            );
        }

        async function exportMemberships() {
            try {
                showToast('Generando reporte detallado...', 'info');

                const response = await api.get('/admin/memberships/export/data');

                if (!response || response.length === 0) {
                    showToast('No hay datos para exportar', 'warning');
                    return;
                }

                const exportData = response.map(m => ({
                    'Folio': m.folio || 'S/N',
                    'Cliente': m.client_name,
                    'Plan': m.plan_name,
                    'Precio': formatCurrency(m.price),
                    'Estado': m.status === 'active' ? 'Activa' : 'Cancelada',
                    'Inicio': formatDate(m.start_date),
                    'Vencimiento': m.end_date ? formatDate(m.end_date) : 'N/A',
                    'Servicios Restantes': m.remaining_services,
                    'Servicio Usado': m.used_service || 'Sin uso',
                    'Fecha Uso': m.usage_date ? formatDateTime(m.usage_date) : '-',
                    'Valor Uso': m.usage_value ? formatCurrency(m.usage_value) : '-',
                    'Sellos': m.stamps_used || '-'
                }));

                exportToExcel(exportData, `Membresias_Detalle_${new Date().toISOString().split('T')[0]}`);

            } catch (error) {
                console.error('Export error:', error);
                showToast('Error al exportar: ' + error.message, 'error');
            }
        }

        // Initial load
        loadMemberships();
    </script>

    <!-- Mobile Menu Script -->
    <!-- Mobile Menu Script Removed -->
</body>

</html>