<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Clientes | Braco's Admin</title>
    <link rel="icon" href="../assets/logo.png" type="image/png">
    <link rel="stylesheet" href="css/admin.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
</head>

<body>
    <!-- Mobile Menu Toggle -->
    <button class="mobile-menu-toggle" id="mobile-menu-toggle" aria-label="Abrir menÃº">
        <i class="fas fa-bars"></i>
    </button>

    <!-- Mobile Overlay -->
    <div class="mobile-overlay" id="mobile-overlay"></div>


    <div class="admin-layout">
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <img src="../assets/logo.png" alt="Logo"
                    style="height: 60px; margin-bottom: 10px; display: block; margin: 0 auto 10px;">
                <p class="sidebar-subtitle">AdministraciÃ³n</p>
            </div>

            <nav class="sidebar-nav">
                <div class="nav-section">
                    <span class="nav-section-title">Principal</span>
                    <a href="index.html" class="nav-item">
                        <span class="nav-icon"><i class="fas fa-chart-line"></i></span>
                        <span>Dashboard</span>
                    </a>
                    <a href="calendario.html" class="nav-item">
                        <span class="nav-icon"><i class="far fa-calendar-alt"></i></span>
                        <span>Calendario</span>
                    </a>
                    <a href="citas.html" class="nav-item">
                        <span class="nav-icon"><i class="fas fa-scissors"></i></span>
                        <span>Citas</span>
                        <span class="badge" id="nav-badge-citas">0</span>
                    </a>
                </div>

                <div class="nav-section">
                    <span class="nav-section-title">GestiÃ³n</span>
                    <a href="clientes.html" class="nav-item active">
                        <span class="nav-icon"><i class="fas fa-users"></i></span>
                        <span>Clientes</span>
                    </a>
                    <a href="membresias.html" class="nav-item">
                        <span class="nav-icon"><i class="fas fa-crown"></i></span>
                        <span>MembresÃ­as</span>
                    </a>
                    <a href="servicios.html" class="nav-item">
                        <span class="nav-icon"><i class="fas fa-cut"></i></span>
                        <span>Servicios</span>
                    </a>
                    <a href="productos.html" class="nav-item">
                        <span class="nav-icon"><i class="fas fa-pump-soap"></i></span>
                        <span>Productos</span>
                    </a>
                </div>

                <div class="nav-section">
                    <span class="nav-section-title">Reportes</span>
                    <a href="reportes.html" class="nav-item">
                        <span class="nav-icon"><i class="fas fa-file-invoice-dollar"></i></span>
                        <span>Ventas</span>
                    </a>
                </div>

                <div class="nav-section">
                    <span class="nav-section-title">Sistema</span>
                    <a href="configuracion.html" class="nav-item">
                        <span class="nav-icon"><i class="fas fa-cog"></i></span>
                        <span>ConfiguraciÃ³n</span>
                    </a>
                </div>
            </nav>

            <div class="sidebar-footer">
                <div class="admin-profile">
                    <div class="admin-avatar" id="admin-avatar">A</div>
                    <div class="admin-info">
                        <div class="admin-name" id="admin-name">Admin</div>
                        <div class="admin-role" id="admin-role">Administrador</div>
                    </div>
                </div>
                <button class="btn-logout" onclick="logout()">Cerrar SesiÃ³n</button>
            </div>
        </aside>

        <main class="main-content">
            <header class="top-header">
                <h1 class="page-title">Clientes</h1>
                <div class="header-actions">
                    <button class="btn btn-primary" onclick="openModal('add-client')">
                        + Nuevo Cliente
                    </button>
                </div>
            </header>

            <div class="page-content">
                <div class="filters-bar">
                    <div class="search-box">
                        <span class="search-icon"><i class="fas fa-search"></i></span>
                        <input type="text" id="search-client" class="search-input" placeholder="Buscar cliente..."
                            oninput="filterClients()">
                    </div>

                    <select class="filter-select" id="filter-type">
                        <option value="">Todos los tipos</option>
                        <option value="1">Nuevo</option>
                        <option value="2">Recurrente</option>
                        <option value="3">Golden Card</option>
                        <option value="4">NeoCapilar</option>
                        <option value="5">Black Card</option>
                    </select>

                    <select class="filter-select" id="filter-membership">
                        <option value="">MembresÃ­a: Todas</option>
                        <option value="active">Con membresÃ­a activa</option>
                        <option value="none">Sin membresÃ­a</option>
                    </select>
                </div>

                <div class="stats-grid" style="margin-bottom: 1.5rem;">
                    <div class="stat-card">
                        <div class="stat-content">
                            <div class="stat-value" id="total-clients">0</div>
                            <div class="stat-label">Total Clientes</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-content">
                            <div class="stat-value" id="new-clients-month">0</div>
                            <div class="stat-label">Nuevos Este Mes</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-content">
                            <div class="stat-value" id="vip-clients">0</div>
                            <div class="stat-label">Clientes VIP</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-content">
                            <div class="stat-value" id="with-membership">0</div>
                            <div class="stat-label">Con MembresÃ­a</div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="table-container">
                        <table class="data-table" id="clients-table">
                            <thead>
                                <tr>
                                    <th>CÃ³digo</th>
                                    <th>Cliente</th>
                                    <th>TelÃ©fono</th>
                                    <th>Tipo</th>
                                    <th>Visitas</th>
                                    <th>Total Gastado</th>
                                    <th>MembresÃ­a</th>
                                    <th>Ãšltima Visita</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="clients-tbody">
                                <!-- Se llena con JavaScript -->
                            </tbody>
                        </table>
                    </div>

                    <div class="pagination" id="pagination">
                        <!-- Se llena con JavaScript -->
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Modal: Agregar/Editar Cliente -->
    <div class="modal-overlay" id="modal-add-client">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title" id="modal-client-title">Nuevo Cliente</h3>
                <button class="modal-close" onclick="closeModal('add-client')">&times;</button>
            </div>
            <form id="client-form">
                <div class="modal-body">
                    <input type="hidden" id="client-id">

                    <div class="form-group">
                        <label class="form-label">Nombre Completo *</label>
                        <input type="text" class="form-input" id="client-name" required>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">TelÃ©fono *</label>
                            <div class="phone-input-group">
                                <select id="client-country-code" class="country-select">
                                    <option value="52" selected>ðŸ‡²ðŸ‡½ +52</option>
                                    <option value="1">ðŸ‡ºðŸ‡¸ +1</option>
                                    <option value="34">ðŸ‡ªðŸ‡¸ +34</option>
                                    <option value="54">ðŸ‡¦ðŸ‡· +54</option>
                                    <option value="57">ðŸ‡¨ðŸ‡´ +57</option>
                                    <option value="56">ðŸ‡¨ðŸ‡± +56</option>
                                    <option value="51">ðŸ‡µðŸ‡ª +51</option>
                                    <option value="58">ðŸ‡»ðŸ‡ª +58</option>
                                    <option value="593">ðŸ‡ªðŸ‡¨ +593</option>
                                    <option value="502">ðŸ‡¬ðŸ‡¹ +502</option>
                                    <option value="503">ðŸ‡¸ðŸ‡» +503</option>
                                    <option value="504">ðŸ‡­ðŸ‡³ +504</option>
                                    <option value="505">ðŸ‡³ðŸ‡® +505</option>
                                    <option value="506">ðŸ‡¨ðŸ‡· +506</option>
                                    <option value="507">ðŸ‡µðŸ‡¦ +507</option>
                                    <option value="55">ðŸ‡§ðŸ‡· +55</option>
                                    <option value="44">ðŸ‡¬ðŸ‡§ +44</option>
                                    <option value="33">ðŸ‡«ðŸ‡· +33</option>
                                    <option value="49">ðŸ‡©ðŸ‡ª +49</option>
                                    <option value="39">ðŸ‡®ðŸ‡¹ +39</option>
                                </select>
                                <input type="tel" class="form-input phone-input" id="client-phone" required
                                    placeholder="NÃºmero local" maxlength="15">
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Email</label>
                            <input type="email" class="form-input" id="client-email">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Fecha de Nacimiento</label>
                            <input type="date" class="form-input" id="client-birthdate">
                            <span class="form-hint" style="font-size: 0.85rem; color: #888;">Para recordatorios de
                                cumpleaÃ±os</span>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Tipo de Cliente</label>
                            <select class="form-select" id="client-type">
                                <option value="1">Nuevo</option>
                                <option value="2">Recurrente</option>
                                <option value="3">Golden Card</option>
                                <option value="4">NeoCapilar</option>
                                <option value="5">Black Card</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Notas</label>
                        <textarea class="form-textarea" id="client-notes" rows="3"
                            placeholder="Preferencias, alergias, etc."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('add-client')">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Guardar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal: Detalle de Cliente -->
    <div class="modal-overlay" id="modal-client-detail">
        <div class="modal" style="max-width: 700px;">
            <div class="modal-header">
                <h3 class="modal-title">Detalle del Cliente</h3>
                <button class="modal-close" onclick="closeModal('client-detail')">&times;</button>
            </div>
            <div class="modal-body" id="client-detail-content">
                <!-- Se llena dinÃ¡micamente -->
            </div>
        </div>
    </div>

    <script src="js/auth.js"></script>
    <script src="js/api.js"></script>
    <script>
        checkAuth();

        let clients = [];
        let currentPage = 1;
        const perPage = 15;

        // Cargar clientes
        async function loadClients() {
            try {
                const data = await api.get('/admin/clients');
                clients = data.clients || [];

                document.getElementById('total-clients').textContent = data.stats?.total || clients.length;
                document.getElementById('new-clients-month').textContent = data.stats?.new_this_month || 0;
                document.getElementById('vip-clients').textContent = data.stats?.vip || 0;
                document.getElementById('with-membership').textContent = data.stats?.with_membership || 0;

                renderClients();
            } catch (error) {
                console.error('Error:', error);
                // Fallback to demo data if API fails or unreachable
                loadDemoClients();
            }
        }

        function renderClients() {
            const searchEl = document.getElementById('search-client');
            const search = searchEl ? searchEl.value.toLowerCase() : '';
            const typeFilter = document.getElementById('filter-type').value;
            const membershipFilter = document.getElementById('filter-membership').value;

            let filtered = clients.filter(c => {
                if (search && !c.name.toLowerCase().includes(search) && (!c.phone || !c.phone.includes(search))) {
                    return false;
                }
                if (typeFilter && c.client_type_id != typeFilter) {
                    return false;
                }
                if (membershipFilter === 'active' && !c.has_active_membership) {
                    return false;
                }
                if (membershipFilter === 'none' && c.has_active_membership) {
                    return false;
                }
                return true;
            });

            const totalPages = Math.ceil(filtered.length / perPage);
            const start = (currentPage - 1) * perPage;
            const paginated = filtered.slice(start, start + perPage);

            const tbody = document.getElementById('clients-tbody');

            if (paginated.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="9" class="text-muted" style="text-align: center; padding: 3rem;">
                            No se encontraron clientes
                        </td>
                    </tr>
                `;
            } else {
                tbody.innerHTML = paginated.map(c => `
                    <tr>
                        <td data-label="CÃ³digo"><code style="background: rgba(196,163,90,0.15); padding: 4px 8px; border-radius: 4px; font-weight: 600; color: var(--gold);">${c.client_code || '-'}</code></td>
                        <td data-label="Cliente">
                            <div>
                                <strong style="display: block;">${c.name}</strong>
                                ${c.email ? `<small class="text-muted" style="display: block; margin-top: 0.25rem;">${c.email}</small>` : ''}
                            </div>
                        </td>
                        <td data-label="TelÃ©fono">${formatPhone(c.phone)}</td>
                        <td data-label="Tipo">${getTypeBadge(c)}</td>
                        <td data-label="Visitas">${c.total_visits || 0}</td>
                        <td data-label="Total" class="text-gold">$${(c.total_spent || 0).toLocaleString()}</td>
                        <td data-label="MembresÃ­a">
                            ${c.has_active_membership
                        ? `<span class="badge badge-success">${c.membership_type || 'Activa'}</span>`
                        : '<span class="text-muted">-</span>'}
                        </td>
                        <td data-label="Ãšltima Visita">${c.last_visit ? formatDate(c.last_visit) : '-'}</td>
                        <td data-label="">
                            <div class="actions">
                                <button class="btn-icon" onclick="resendCode(${c.id}, '${(c.name || '').replace(/'/g, "\\'")}', event)" title="Reenviar cÃ³digo"><i class="fab fa-whatsapp"></i></button>
                                <button class="btn-icon" onclick="viewClient(${c.id})" title="Ver detalle"><i class="fas fa-eye"></i></button>
                                <button class="btn-icon" onclick="editClient(${c.id})" title="Editar"><i class="fas fa-edit"></i></button>
                                <button class="btn-icon" onclick="deleteClient(${c.id})" title="Eliminar"><i class="fas fa-trash"></i></button>
                            </div>
                        </td>
                    </tr>
                `).join('');
            }

            renderPagination(filtered.length, totalPages);
        }

        function renderPagination(total, totalPages) {
            const pagination = document.getElementById('pagination');

            if (totalPages <= 1) {
                pagination.innerHTML = '';
                return;
            }

            let html = `
                <button class="pagination-btn" onclick="goToPage(${currentPage - 1})" ${currentPage === 1 ? 'disabled' : ''}>
                    â€¹
                </button>
            `;

            for (let i = 1; i <= totalPages; i++) {
                if (i === 1 || i === totalPages || (i >= currentPage - 2 && i <= currentPage + 2)) {
                    html += `
                        <button class="pagination-btn ${i === currentPage ? 'active' : ''}" onclick="goToPage(${i})">
                            ${i}
                        </button>
                    `;
                } else if (i === currentPage - 3 || i === currentPage + 3) {
                    html += '<span style="padding: 0 0.5rem;">...</span>';
                }
            }

            html += `
                <button class="pagination-btn" onclick="goToPage(${currentPage + 1})" ${currentPage === totalPages ? 'disabled' : ''}>
                    â€º
                </button>
            `;

            pagination.innerHTML = html;
        }

        function goToPage(page) {
            currentPage = page;
            renderClients();
        }

        // Eventos de filtros
        document.getElementById('search-client').addEventListener('input', () => {
            currentPage = 1;
            renderClients();
        });

        document.getElementById('filter-type').addEventListener('change', () => {
            currentPage = 1;
            renderClients();
        });

        document.getElementById('filter-membership').addEventListener('change', () => {
            currentPage = 1;
            renderClients();
        });

        // CRUD Operations
        function openModal(id) {
            document.getElementById(`modal-${id}`).classList.add('active');
        }

        function closeModal(id) {
            document.getElementById(`modal-${id}`).classList.remove('active');
        }

        document.getElementById('client-form').addEventListener('submit', async (e) => {
            e.preventDefault();

            const clientId = document.getElementById('client-id').value;

            // Combinar country code + phone
            const countryCode = document.getElementById('client-country-code').value;
            const localPhone = document.getElementById('client-phone').value.replace(/\D/g, '');
            const fullPhone = countryCode + localPhone;

            const data = {
                name: document.getElementById('client-name').value,
                phone: fullPhone,
                email: document.getElementById('client-email').value,
                birthdate: document.getElementById('client-birthdate').value || null,
                client_type_id: document.getElementById('client-type').value,
                notes: document.getElementById('client-notes').value
            };

            try {
                if (clientId) {
                    await api.put(`/admin/clients/${clientId}`, data);
                } else {
                    await api.post('/admin/clients', data);
                }
                closeModal('add-client');
                loadClients();
            } catch (error) {
                alert('Error al guardar: ' + error.message);
            }
        });

        function editClient(id) {
            const client = clients.find(c => c.id === id);
            if (!client) return;

            document.getElementById('modal-client-title').textContent = 'Editar Cliente';
            document.getElementById('client-id').value = client.id;
            document.getElementById('client-name').value = client.name;

            // Handle phone with country code
            const countrySelect = document.getElementById('client-country-code');
            const phoneInput = document.getElementById('client-phone');
            let phone = client.phone || '';

            // Default to Mexico if no match found
            let matchedCode = '52';
            let localPhone = phone;

            const countryCodes = ['593', '502', '503', '504', '505', '506', '507', '52', '54', '55', '56', '57', '58', '34', '33', '39', '44', '49', '1'];
            // Sort by length desc
            countryCodes.sort((a, b) => b.length - a.length);

            for (const code of countryCodes) {
                if (phone.startsWith(code)) {
                    matchedCode = code;
                    localPhone = phone.substring(code.length);
                    break;
                }
            }

            if (countrySelect) countrySelect.value = matchedCode;
            if (phoneInput) phoneInput.value = localPhone;

            document.getElementById('client-email').value = client.email || '';

            // Format birthdate to YYYY-MM-DD for date input
            let birthdate = '';
            if (client.birthdate) {
                // If it's an ISO string with T, extract just the date part
                if (typeof client.birthdate === 'string' && client.birthdate.includes('T')) {
                    birthdate = client.birthdate.split('T')[0];
                } else {
                    birthdate = client.birthdate;
                }
            }
            document.getElementById('client-birthdate').value = birthdate;

            document.getElementById('client-type').value = client.client_type_id;
            document.getElementById('client-notes').value = client.notes || '';

            openModal('add-client');
        }

        async function viewClient(id) {
            const client = clients.find(c => c.id === id);
            if (!client) return;

            // Fetch detailed data including history
            let detailData = { client, appointments: [] };
            let historyData = { recent_appointments: [] };

            try {
                const [clientRes, historyRes] = await Promise.all([
                    api.get(`/admin/clients/${id}`),
                    api.get(`/admin/clients/${id}/history`)
                ]);
                detailData = clientRes;
                historyData = historyRes;
            } catch (e) {
                console.warn("Could not fetch details or history", e);
            }

            // Combine fetched detailed info or fallback to listed info
            const c = detailData.client || client;
            const appointments = historyData.recent_appointments || [];

            // Status badge helper
            const getStatusBadge = (status) => {
                const statusMap = {
                    'scheduled': '<span class="badge" style="background:#3498db">Agendada</span>',
                    'confirmed': '<span class="badge badge-success">Confirmada</span>',
                    'in_progress': '<span class="badge" style="background:#f39c12">En progreso</span>',
                    'completed': '<span class="badge" style="background:#27ae60">Completada</span>',
                    'cancelled': '<span class="badge" style="background:#e74c3c">Cancelada</span>',
                    'no_show': '<span class="badge" style="background:#7f8c8d">No asistiÃ³</span>',
                    'pending': '<span class="badge" style="background:#e67e22">Pendiente</span>'
                };
                return statusMap[status] || `<span class="badge">${status}</span>`;
            };

            // Format appointment date
            const formatApptDate = (dateStr) => {
                if (!dateStr) return '-';
                const d = dateStr.includes('T') ? dateStr.split('T')[0] : dateStr;
                return new Date(d + 'T12:00:00').toLocaleDateString('es-MX', {
                    day: 'numeric', month: 'short', year: 'numeric'
                });
            };

            // Build appointments table
            const appointmentsHtml = appointments.length > 0 ? `
                <div style="margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid rgba(196,163,90,0.1);">
                    <h4 style="color: var(--gold); margin-bottom: 1rem;"><i class="fas fa-history"></i> Historial de Citas (${appointments.length})</h4>
                    <div style="max-height: 250px; overflow-y: auto;">
                        <table class="data-table" style="font-size: 0.9rem;">
                            <thead>
                                <tr>
                                    <th>Fecha</th>
                                    <th>Hora</th>
                                    <th>Servicio</th>
                                    <th>Estado</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${appointments.map(a => `
                                    <tr>
                                        <td>${formatApptDate(a.appointment_date)}</td>
                                        <td>${a.start_time ? a.start_time.slice(0, 5) : '-'}</td>
                                        <td>${a.service_name || '-'}</td>
                                        <td>${getStatusBadge(a.status)}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            ` : `
                <div style="margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid rgba(196,163,90,0.1);">
                    <h4 style="color: var(--gold); margin-bottom: 1rem;"><i class="fas fa-history"></i> Historial de Citas</h4>
                    <p class="text-muted">Este cliente no tiene citas registradas.</p>
                </div>
            `;

            document.getElementById('client-detail-content').innerHTML = `
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem;">
                    <div>
                        <h4 style="color: var(--gold); margin-bottom: 1rem;">InformaciÃ³n</h4>
                        <p><strong>CÃ³digo de Cliente:</strong> <code style="background: rgba(196,163,90,0.2); padding: 4px 10px; border-radius: 4px; font-size: 1.2rem; font-weight: 700; color: var(--gold);">${c.client_code || '-'}</code></p>
                        <p><strong>Nombre:</strong> ${c.name}</p>
                        <p><strong>TelÃ©fono:</strong> ${formatPhone(c.phone)}</p>
                        <p><strong>Email:</strong> ${c.email || '-'}</p>
                        <p><strong>Tipo:</strong> <span class="badge badge-gold">${c.client_type_name || 'Normal'}</span></p>
                        <p><strong>Notas:</strong> ${c.notes || '-'}</p>
                    </div>
                    <div>
                        <h4 style="color: var(--gold); margin-bottom: 1rem;">EstadÃ­sticas</h4>
                        <p><strong>Total Visitas:</strong> ${c.total_visits || 0}</p>
                        <p><strong>Total Gastado:</strong> $${(c.total_spent || 0).toLocaleString()}</p>
                        <p><strong>Ãšltima Visita:</strong> ${c.last_visit ? formatDate(c.last_visit) : 'Nunca'}</p>
                        <p><strong>Cliente desde:</strong> ${formatDate(c.created_at)}</p>
                    </div>
                </div>
                ${c.has_active_membership ? `
                    <div style="margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid rgba(196,163,90,0.1);">
                        <h4 style="color: var(--gold); margin-bottom: 1rem;">MembresÃ­a Activa</h4>
                        <p><strong>Plan:</strong> ${c.membership_type || 'Activa'}</p>
                        <p><strong>Servicios Restantes:</strong> ${c.remaining_services || '?'}/${c.total_services || '?'}</p>
                        <p><strong>Vence:</strong> ${c.membership_expiration ? formatDate(c.membership_expiration) : '-'}</p>
                    </div>
                ` : ''}
                ${appointmentsHtml}
            `;
            openModal('client-detail');
        }

        async function deleteClient(id) {
            if (!confirm('Â¿Eliminar este cliente?')) return;

            try {
                await api.delete(`/admin/clients/${id}`);
                loadClients();
            } catch (error) {
                alert('Error al eliminar: ' + error.message);
            }
        }

        // Utilidades
        function formatPhone(phone) {
            if (!phone) return '-';
            return phone.replace(/(\d{2})(\d{4})(\d{4})/, '$1 $2 $3');
        }

        function formatDate(date) {
            if (!date) return '-';
            // Evitar conversiÃ³n de timezone
            let dateStr = date;
            if (typeof date === 'string' && date.length === 10) {
                dateStr = date + 'T12:00:00';
            } else if (typeof date === 'string' && date.includes('T')) {
                dateStr = date.split('T')[0] + 'T12:00:00';
            }
            return new Date(dateStr).toLocaleDateString('es-MX', {
                day: 'numeric',
                month: 'short',
                year: 'numeric'
            });
        }

        // Generar badge de tipo de cliente
        function getTypeBadge(c) {
            const isNew = c.client_type_id === 1;
            if (isNew) {
                return `<span class="badge badge-gold" style="cursor: pointer;" onclick="promoteClient(${c.id}, '${(c.name || '').replace(/'/g, "\\'")}', event)" title="Clic para promover a Recurrente">${c.client_type_name || 'Nuevo'} <i class="fas fa-arrow-up" style="font-size: 0.7rem; margin-left: 4px;"></i></span>`;
            }
            return `<span class="badge badge-gold">${c.client_type_name || 'Normal'}</span>`;
        }

        // Promover cliente de Nuevo a Recurrente
        async function promoteClient(id, name, event) {
            event.stopPropagation();

            if (!confirm(`Â¿Promover a "${name}" a cliente Recurrente?\n\nSe le enviarÃ¡ un email y WhatsApp con su cÃ³digo de cliente.`)) {
                return;
            }

            try {
                const result = await api.post(`/admin/clients/${id}/promote`);

                let message = `âœ… ${name} ahora es cliente Recurrente\n\nCÃ³digo: ${result.client_code}`;

                if (result.notifications.email) {
                    message += '\nðŸ“§ Email enviado';
                }
                if (result.notifications.whatsapp) {
                    message += '\nðŸ“± WhatsApp enviado';
                }

                alert(message);
                loadClients(); // Recargar lista

            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        // Reenviar cÃ³digo de cliente por WhatsApp
        async function resendCode(id, name, event) {
            event.stopPropagation();

            if (!confirm(`Â¿Reenviar cÃ³digo de cliente a "${name}" por WhatsApp?`)) {
                return;
            }

            try {
                const result = await api.post(`/admin/clients/${id}/resend-code`);

                let message = `âœ… CÃ³digo reenviado a ${name}\n\nCÃ³digo: ${result.client_code}`;

                if (result.notifications.whatsapp) {
                    message += '\nðŸ“± WhatsApp enviado';
                }
                if (result.notifications.email) {
                    message += '\nðŸ“§ Email enviado';
                }

                alert(message);

            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        // Demo data
        function loadDemoClients() {
            clients = [
                { id: 1, name: 'Carlos Mendoza', phone: '4421234567', email: 'carlos@email.com', client_type_id: 1, client_type_name: 'Normal', client_color: '#C4A35A', total_visits: 12, total_spent: 4500, has_active_membership: false, created_at: '2024-01-15' },
                { id: 2, name: 'Roberto GarcÃ­a', phone: '4429876543', email: 'roberto@email.com', client_type_id: 2, client_type_name: 'Premium', client_color: '#D4B76A', total_visits: 24, total_spent: 12000, has_active_membership: true, membership_type: 'Premium 6', remaining_services: 4, total_services: 6, created_at: '2023-08-20', last_visit: '2024-12-01' },
                { id: 3, name: 'Miguel Torres', phone: '4425551234', email: '', client_type_id: 3, client_type_name: 'VIP', client_color: '#1A1A1A', total_visits: 48, total_spent: 35000, has_active_membership: true, membership_type: 'VIP 12', remaining_services: 8, total_services: 12, created_at: '2022-03-10', last_visit: '2024-12-03' }
            ];

            document.getElementById('total-clients').textContent = '156';
            document.getElementById('new-clients-month').textContent = '12';
            document.getElementById('vip-clients').textContent = '8';
            document.getElementById('with-membership').textContent = '24';

            renderClients();
        }

        // Reset form al abrir modal de nuevo cliente
        document.querySelector('[onclick="openModal(\'add-client\')"]').addEventListener('click', () => {
            document.getElementById('modal-client-title').textContent = 'Nuevo Cliente';
            document.getElementById('client-form').reset();
            document.getElementById('client-id').value = '';
            // Reset country to Mexico default
            document.getElementById('client-country-code').value = '52';
        });

        // Inicializar
        loadClients();
    </script>
    <script src="js/sidebar.js"></script>
    <script src="../js/admin.js"></script>
</body>

</html>