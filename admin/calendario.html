<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calendario | Braco's Admin</title>
    <link rel="icon" href="../assets/logo.png" type="image/png">
    <link
        href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@400;500;600;700&family=Montserrat:wght@300;400;500;600&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="stylesheet" href="css/admin.css">
    <link rel="stylesheet" href="css/gcalendar.css">
</head>

<body>
    <!-- Mobile Menu Toggle -->
    <button class="mobile-menu-toggle" id="mobile-menu-toggle" aria-label="Abrir menú">
        <i class="fas fa-bars"></i>
    </button>

    <!-- Mobile Overlay -->
    <div class="mobile-overlay" id="mobile-overlay"></div>

    <div class="admin-layout">
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <img src="../assets/logo.png" alt="Logo"
                    style="height: 60px; margin-bottom: 10px; display: block; margin: 0 auto 10px;">
                <p class="sidebar-subtitle">Administración</p>
            </div>

            <nav class="sidebar-nav">
                <div class="nav-section">
                    <span class="nav-section-title">Principal</span>
                    <a href="index.html" class="nav-item">
                        <span class="nav-icon"><i class="fas fa-chart-line"></i></span>
                        <span>Dashboard</span>
                    </a>
                    <a href="calendario.html" class="nav-item active">
                        <span class="nav-icon"><i class="far fa-calendar-alt"></i></span>
                        <span>Calendario</span>
                    </a>
                    <a href="citas.html" class="nav-item">
                        <span class="nav-icon"><i class="fas fa-scissors"></i></span>
                        <span>Citas</span>
                        <span class="badge" id="nav-badge-citas">0</span>
                    </a>
                </div>

                <div class="nav-section">
                    <span class="nav-section-title">Gestión</span>
                    <a href="clientes.html" class="nav-item">
                        <span class="nav-icon"><i class="fas fa-users"></i></span>
                        <span>Clientes</span>
                    </a>
                    <a href="membresias.html" class="nav-item">
                        <span class="nav-icon"><i class="fas fa-crown"></i></span>
                        <span>Membresías</span>
                    </a>
                    <a href="servicios.html" class="nav-item">
                        <span class="nav-icon"><i class="fas fa-cut"></i></span>
                        <span>Servicios</span>
                    </a>
                    <a href="productos.html" class="nav-item">
                        <span class="nav-icon"><i class="fas fa-pump-soap"></i></span>
                        <span>Productos</span>
                    </a>
                </div>

                <div class="nav-section">
                    <span class="nav-section-title">Reportes</span>
                    <a href="reportes.html" class="nav-item">
                        <span class="nav-icon"><i class="fas fa-file-invoice-dollar"></i></span>
                        <span>Ventas</span>
                    </a>
                </div>

                <div class="nav-section">
                    <span class="nav-section-title">Sistema</span>
                    <a href="configuracion.html" class="nav-item">
                        <span class="nav-icon"><i class="fas fa-cog"></i></span>
                        <span>Configuración</span>
                    </a>
                </div>
            </nav>

            <div class="sidebar-footer">
                <div class="admin-profile">
                    <div class="admin-avatar" id="admin-avatar">A</div>
                    <div class="admin-info">
                        <div class="admin-name" id="admin-name">Admin</div>
                        <div class="admin-role" id="admin-role">Administrador</div>
                    </div>
                </div>
                <button class="btn-logout" onclick="logout()">Cerrar Sesión</button>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <header class="main-header">
                <div class="header-title">
                    <h2>Calendario de Citas</h2>
                    <p class="header-date" id="current-date"></p>
                </div>
            </header>

            <!-- Calendar Controls Bar -->
            <section class="content-section calendar-controls-section">
                <div class="calendar-controls-wrapper">
                    <!-- Navigation -->
                    <div class="calendar-nav">
                        <button class="btn-icon" onclick="previousPeriod()" title="Anterior"><i
                                class="fas fa-chevron-left"></i></button>
                        <h3 class="calendar-title" id="calendar-title">Diciembre 2024</h3>
                        <button class="btn-icon" onclick="nextPeriod()" title="Siguiente"><i
                                class="fas fa-chevron-right"></i></button>
                    </div>

                    <!-- View Controls -->
                    <div class="calendar-view-controls">
                        <button class="btn btn-secondary btn-sm" onclick="goToday()">HOY</button>
                        <select id="view-select" class="form-select">
                            <option value="month">Mes</option>
                            <option value="week" selected>Semana</option>
                            <option value="day">Día</option>
                        </select>
                    </div>

                    <!-- New Appointment -->
                    <div class="calendar-new-btn" style="display: flex; gap: 0.5rem;">
                        <button class="btn btn-primary" onclick="openNewAppointmentModal(new Date(), '09:00')">
                            <i class="fas fa-plus"></i> <span class="btn-text">Nueva Cita</span>
                        </button>
                        <button class="btn btn-secondary"
                            onclick="openBlockTimeModal(formatDateYMD(new Date()), '10:00')"
                            title="Bloquear horario">
                            <i class="fas fa-ban"></i> <span class="btn-text">Bloquear</span>
                        </button>
                    </div>
                </div>
            </section>

            <!-- Unified Calendar Container -->
            <section class="content-section">
                <div id="calendar-main" class="calendar-main-container">
                    <!-- El contenido cambia dinámicamente según la vista -->
                </div>
            </section>

            <!-- Side Panel para detalles de cita - Google Calendar Style -->
            <div id="appointment-side-panel" class="gcal-side-panel hidden">
                <div class="gcal-side-panel-header">
                    <button class="btn-icon" onclick="closeSidePanel()"><i class="fas fa-times"></i></button>
                </div>
                <div class="gcal-side-panel-content" id="side-panel-content">
                    <!-- Contenido dinámico -->
                </div>
            </div>

            <!-- Filters & Legend -->
            <section class="content-section">
                <div class="section-header"
                    style="margin-bottom: 1.5rem; padding-bottom: 1rem; border-bottom: 1px solid rgba(196, 163, 90, 0.1);">
                    <h3 style="font-family: 'Cormorant Garamond', serif; font-size: 1.3rem; color: var(--gold);">
                        <i class="fas fa-filter"></i> Filtros y Estados
                    </h3>
                </div>

                <div class="filters-bar">
                    <select id="filter-status" class="search-input" style="width: auto;">
                        <option value="">Todos los estados</option>
                        <option value="pending">Pendientes (Depósito)</option>
                        <option value="scheduled">Agendadas</option>
                        <option value="confirmed">Confirmadas</option>
                        <option value="in_progress">En Curso</option>
                        <option value="completed">Completadas</option>
                        <option value="cancelled">Canceladas</option>
                        <option value="no_show">No Asistió</option>
                    </select>

                    <input type="text" id="filter-search" class="search-input"
                        placeholder="Buscar por cliente o servicio...">

                    <label class="filter-checkbox"
                        style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; color: var(--cream); font-size: 0.9rem;">
                        <input type="checkbox" id="filter-show-cancelled"
                            style="width: 18px; height: 18px; accent-color: var(--gold);">
                        <span>Mostrar canceladas</span>
                    </label>
                </div>

                <div style="display: flex; gap: 1rem; flex-wrap: wrap; margin-top: 1rem;">
                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                        <span class="appointment-status pending"><i class="fas fa-hourglass-half"></i> Pendiente</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                        <span class="appointment-status scheduled"><i class="far fa-calendar"></i> Agendada</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                        <span class="appointment-status confirmed"><i class="fas fa-check-circle"></i> Confirmada</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                        <span class="appointment-status in_progress"><i class="fas fa-clock"></i> En Curso</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                        <span class="appointment-status completed"><i class="fas fa-check-double"></i> Completada</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                        <span class="appointment-status cancelled"><i class="fas fa-times-circle"></i> Cancelada</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                        <span class="appointment-status no_show"><i class="fas fa-user-slash"></i> No Asistió</span>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <script src="../js/admin.js"></script>
    <script>
        checkAuth();

        // State
        let currentView = 'week';
        let currentDate = new Date();
        let allAppointments = [];
        let filteredAppointments = [];
        let allClients = [];
        let allServices = [];

        // Helper: Formatear fecha como YYYY-MM-DD sin problemas de zona horaria
        function formatDateYMD(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        // Colores por servicio/estilista y tipo de cliente
        // Miguel (Rojo): Dúo, Corte de cabello, Barba, Prótesis capilar
        // Bárbara (Azul marino): TIC, Mascarillas, Manicura, Pedicura
        // Golden Card (Morado), Black Card (Negro)
        function getAppointmentColor(serviceName, clientColor) {
            const name = serviceName?.toLowerCase() || '';

            // Si el cliente es Golden Card o Black Card, usar color especial
            if (clientColor) {
                const color = clientColor.toLowerCase();
                // Golden Card - Morado (color en BD es #FFD700 dorado, pero queremos morado)
                if (color === '#ffd700' || color.includes('ffd700')) {
                    return '#8B5CF6'; // Morado
                }
                // Black Card - Negro
                if (color === '#1a1a1a' || color.includes('1a1a1a')) {
                    return '#1a1a1a';
                }
            }

            // Black Card por nombre de servicio - Negro
            if (name.includes('black')) return '#1a1a1a';

            // Golden Card por nombre de servicio - Morado
            if (name.includes('golden')) return '#8B5CF6';

            // Bárbara (Azul marino) - TIC, mascarillas, manicura, pedicura
            if (name.includes('tic') || name.includes('neocapilar') ||
                name.includes('mascarilla') || name.includes('manicura') ||
                name.includes('pedicura') || name.includes('facial') ||
                name.includes('limpieza')) {
                return '#1E3A5F'; // Azul marino
            }

            // Miguel (Rojo) - Dúo, corte, barba, prótesis
            if (name.includes('dúo') || name.includes('duo') ||
                name.includes('corte') || name.includes('barba') ||
                name.includes('prótesis') || name.includes('protesis') ||
                name.includes('cabello')) {
                return '#DC2626'; // Rojo
            }

            // Default - Dorado
            return '#C4A35A';
        }

        // Alias para compatibilidad
        function getServiceColor(serviceName) {
            return getAppointmentColor(serviceName, null);
        }

        // Initialize
        document.getElementById('current-date').textContent =
            new Date().toLocaleDateString('es-MX', {
                weekday: 'long', day: 'numeric', month: 'long', year: 'numeric'
            });

        // Event Listeners
        document.getElementById('view-select').addEventListener('change', (e) => {
            currentView = e.target.value;
            renderCalendar();
        });

        document.getElementById('filter-status').addEventListener('change', applyFilters);
        document.getElementById('filter-search').addEventListener('input', debounce(applyFilters, 300));
        document.getElementById('filter-show-cancelled').addEventListener('change', applyFilters);

        // Load appointments
        async function loadAppointments() {
            try {
                const startDate = formatDateYMD(getMonthStart(currentDate));
                const endDate = formatDateYMD(getMonthEnd(currentDate));

                console.log('Loading appointments from', startDate, 'to', endDate);

                const data = await AdminAPI.getAppointments({
                    start_date: startDate,
                    end_date: endDate
                });

                console.log('API response:', data);

                // data is an array from the API, normalize it
                allAppointments = Array.isArray(data) ? data : (data.appointments || []);

                console.log('Loaded appointments:', allAppointments.length);
                if (allAppointments.length > 0) {
                    console.log('Sample appointment:', allAppointments[0]);
                }

                applyFilters();

            } catch (error) {
                console.error('Error loading appointments:', error);
                showToast('Error al cargar las citas', 'error');
            }
        }

        function applyFilters() {
            const statusFilter = document.getElementById('filter-status').value;
            const searchFilter = document.getElementById('filter-search').value.toLowerCase();
            const showCancelled = document.getElementById('filter-show-cancelled').checked;

            filteredAppointments = allAppointments.filter(apt => {
                // Status filter
                if (statusFilter) {
                    if (apt.status !== statusFilter) return false;
                }

                // Ocultar canceladas por defecto (a menos que el checkbox esté marcado o se filtró específicamente por canceladas)
                if (!showCancelled && statusFilter !== 'cancelled' && apt.status === 'cancelled') {
                    return false;
                }

                // Search filter
                if (searchFilter) {
                    const searchText = `${apt.client_name} ${apt.service_name}`.toLowerCase();
                    if (!searchText.includes(searchFilter)) return false;
                }

                return true;
            });

            console.log('Filtered appointments:', filteredAppointments.length);

            renderCalendar();
        }

        function renderCalendar() {
            console.log('Rendering calendar:', currentView, 'Appointments:', filteredAppointments.length);

            // Render vista según el modo actual
            if (currentView === 'month') {
                renderMonthView();
            } else if (currentView === 'week') {
                renderWeekView();
            } else if (currentView === 'day') {
                renderDayView();
            }
        }

        function renderMonthView() {
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();

            // Update title
            document.getElementById('calendar-title').textContent =
                currentDate.toLocaleDateString('es-MX', { month: 'long', year: 'numeric' });

            // Get first day of month and number of days
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const daysInMonth = lastDay.getDate();
            
            // Convertir día de semana: JS usa 0=Dom, queremos 0=Lun
            // Lunes=0, Martes=1, ..., Domingo=6
            const jsDay = firstDay.getDay(); // 0=Dom, 1=Lun, ..., 6=Sab
            const startingDayOfWeek = jsDay === 0 ? 6 : jsDay - 1;

            // Build calendar HTML
            let html = '';

            // Day headers - Semana empieza en Lunes
            const dayNames = ['Lun', 'Mar', 'Mié', 'Jue', 'Vie', 'Sáb', 'Dom'];
            dayNames.forEach(day => {
                html += `<div class="calendar-day-header">${day}</div>`;
            });

            // Empty cells before first day
            for (let i = 0; i < startingDayOfWeek; i++) {
                html += '<div class="calendar-day other-month"></div>';
            }

            // Days of month
            for (let day = 1; day <= daysInMonth; day++) {
                const date = new Date(year, month, day);
                const dateStr = formatDateYMD(date);
                const isToday = isSameDay(date, new Date());

                // Get appointments for this day
                const dayAppointments = filteredAppointments.filter(apt => {
                    // Normalize date format from database
                    const aptDate = apt.appointment_date.split('T')[0];
                    return aptDate === dateStr;
                });

                console.log(`Day ${day} (${dateStr}):`, dayAppointments.length, 'appointments');

                html += `
                    <div class="calendar-day ${isToday ? 'today' : ''}">
                        <div class="calendar-day-number">${day}</div>
                        <div class="calendar-appointments">
                            ${dayAppointments.map(apt => `
                                <div class="calendar-appointment ${apt.status}"
                                     onclick="viewAppointmentDetail(${apt.id})"
                                     title="${apt.start_time.slice(0, 5)} - ${apt.client_name} - ${apt.service_name}"
                                     style="background-color: ${getAppointmentColor(apt.service_name, apt.client_color)}; border-left: 3px solid ${getAppointmentColor(apt.service_name, apt.client_color)};">
                                    ${apt.start_time.slice(0, 5)} ${apt.client_name}
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }

            // Fill remaining cells
            const totalCells = Math.ceil((startingDayOfWeek + daysInMonth) / 7) * 7;
            const remainingCells = totalCells - (startingDayOfWeek + daysInMonth);
            for (let i = 0; i < remainingCells; i++) {
                html += '<div class="calendar-day other-month"></div>';
            }

            // Render into main container with calendar-grid class
            const container = document.getElementById('calendar-main');
            container.className = 'calendar-grid';
            container.innerHTML = html;
        }

        // Vista Semanal - Google Calendar Style
        function renderWeekView() {
            const startOfWeek = new Date(currentDate);
            // Calcular el lunes de esta semana
            const jsDay = currentDate.getDay(); // 0=Dom, 1=Lun, ..., 6=Sab
            const daysToMonday = jsDay === 0 ? -6 : 1 - jsDay;
            startOfWeek.setDate(currentDate.getDate() + daysToMonday);

            document.getElementById('calendar-title').textContent =
                `Semana del ${startOfWeek.toLocaleDateString('es-MX', { day: 'numeric', month: 'short' })}`;

            // Generate week header - Lun a Dom
            let headerHTML = '<div class="gcal-week-header-cell"></div>'; // Empty cell for time column
            const dayNames = ['Lun', 'Mar', 'Mié', 'Jue', 'Vie', 'Sáb', 'Dom'];

            for (let i = 0; i < 7; i++) {
                const date = addDays(startOfWeek, i);
                const isToday = isSameDay(date, new Date());

                headerHTML += `
                    <div class="gcal-week-header-cell ${isToday ? 'today' : ''}">
                        <div class="gcal-week-header-day">${dayNames[i]}</div>
                        <div class="gcal-week-header-date">${date.getDate()}</div>
                    </div>
                `;
            }

            // Generate time grid (7 AM to 9 PM)
            let gridHTML = '';
            for (let hour = 7; hour <= 21; hour++) {
                // Time label
                gridHTML += `
                    <div class="gcal-time-slot gcal-time-label">
                        ${hour.toString().padStart(2, '0')}:00
                    </div>
                `;

                // Day columns
                for (let i = 0; i < 7; i++) {
                    const date = addDays(startOfWeek, i);
                    const dateStr = formatDateYMD(date);

                    // Find appointments for this hour and day
                    const hourAppointments = filteredAppointments.filter(apt => {
                        const aptDate = apt.appointment_date.split('T')[0];
                        if (aptDate !== dateStr) return false;
                        const aptHour = parseInt(apt.start_time.split(':')[0]);
                        return aptHour === hour;
                    });

                    gridHTML += `<div class="gcal-time-slot gcal-day-column"
                                     onclick="openNewAppointmentModal('${dateStr}', '${hour.toString().padStart(2, '0')}:00')"
                                     oncontextmenu="event.preventDefault(); openBlockTimeModal('${dateStr}', '${hour.toString().padStart(2, '0')}:00')"
                                     title="Click: Nueva cita | Click derecho: Bloquear"
                                     style="cursor: pointer;">`;

                    hourAppointments.forEach(apt => {
                        const startMinutes = parseInt(apt.start_time.split(':')[1]);
                        const endHour = parseInt(apt.end_time.split(':')[0]);
                        const endMinutes = parseInt(apt.end_time.split(':')[1]);

                        const duration = (endHour - hour) * 60 + (endMinutes - startMinutes);
                        const height = (duration / 60) * 60; // 60px por hora
                        const top = (startMinutes / 60) * 60;

                        gridHTML += `
                            <div class="gcal-appointment ${apt.status}"
                                 onclick="event.stopPropagation(); viewAppointmentDetail(${apt.id})"
                                 style="top: ${top}px; height: ${Math.max(height, 30)}px; background-color: ${getAppointmentColor(apt.service_name, apt.client_color)};">
                                <span class="gcal-appointment-time">${apt.start_time.slice(0, 5)}</span>
                                <span class="gcal-appointment-client">${apt.client_name}</span>
                                <span class="gcal-appointment-service">${apt.service_name}</span>
                            </div>
                        `;
                    });

                    gridHTML += `</div>`;
                }
            }

            // Build complete week view HTML
            const html = `
                <div class="gcal-week-header">${headerHTML}</div>
                <div class="gcal-week-grid">${gridHTML}</div>
            `;

            // Render into main container with week view class
            const container = document.getElementById('calendar-main');
            container.className = 'gcal-week-view';
            container.innerHTML = html;
        }

        // Vista Diaria - Google Calendar Style
        function renderDayView() {
            document.getElementById('calendar-title').textContent =
                currentDate.toLocaleDateString('es-MX', {
                    weekday: 'long', day: 'numeric', month: 'long', year: 'numeric'
                });

            const dateStr = formatDateYMD(currentDate);

            // Generate time grid (7 AM to 9 PM)
            let gridHTML = '';
            for (let hour = 7; hour <= 21; hour++) {
                // Time label
                gridHTML += `
                    <div class="gcal-time-slot gcal-time-label">
                        ${hour.toString().padStart(2, '0')}:00
                    </div>
                `;

                // Find appointments for this hour
                const hourAppointments = filteredAppointments.filter(apt => {
                    const aptDate = apt.appointment_date.split('T')[0];
                    if (aptDate !== dateStr) return false;
                    const aptHour = parseInt(apt.start_time.split(':')[0]);
                    return aptHour === hour;
                });

                gridHTML += `<div class="gcal-time-slot gcal-day-column"
                                 onclick="openNewAppointmentModal('${dateStr}', '${hour.toString().padStart(2, '0')}:00')"
                                 oncontextmenu="event.preventDefault(); openBlockTimeModal('${dateStr}', '${hour.toString().padStart(2, '0')}:00')"
                                 title="Click: Nueva cita | Click derecho: Bloquear"
                                 style="cursor: pointer;">`;

                hourAppointments.forEach(apt => {
                    const startMinutes = parseInt(apt.start_time.split(':')[1]);
                    const endHour = parseInt(apt.end_time.split(':')[0]);
                    const endMinutes = parseInt(apt.end_time.split(':')[1]);

                    const duration = (endHour - hour) * 60 + (endMinutes - startMinutes);
                    const height = (duration / 60) * 60; // 60px por hora
                    const top = (startMinutes / 60) * 60;

                    gridHTML += `
                        <div class="gcal-appointment ${apt.status}"
                             onclick="event.stopPropagation(); viewAppointmentDetail(${apt.id})"
                             style="top: ${top}px; height: ${Math.max(height, 40)}px; background-color: ${getAppointmentColor(apt.service_name, apt.client_color)};">
                            <span class="gcal-appointment-time">${apt.start_time.slice(0, 5)} - ${apt.end_time.slice(0, 5)}</span>
                            <span class="gcal-appointment-client">${apt.client_name}</span>
                            <span class="gcal-appointment-service">${apt.service_name}</span>
                        </div>
                    `;
                });

                gridHTML += `</div>`;
            }

            // Build complete day view HTML
            const html = `<div class="gcal-day-grid">${gridHTML}</div>`;

            // Render into main container with day view class
            const container = document.getElementById('calendar-main');
            container.className = 'gcal-day-view';
            container.innerHTML = html;
        }

        function previousPeriod() {
            if (currentView === 'month') {
                currentDate = addMonths(currentDate, -1);
            } else if (currentView === 'week') {
                currentDate = addDays(currentDate, -7);
            } else {
                currentDate = addDays(currentDate, -1);
            }
            loadAppointments();
        }

        function nextPeriod() {
            if (currentView === 'month') {
                currentDate = addMonths(currentDate, 1);
            } else if (currentView === 'week') {
                currentDate = addDays(currentDate, 7);
            } else {
                currentDate = addDays(currentDate, 1);
            }
            loadAppointments();
        }

        function goToday() {
            currentDate = new Date();
            loadAppointments();
        }

        async function viewAppointmentDetail(id) {
            try {
                // Find appointment in current data first for instant feedback
                const apt = allAppointments.find(a => a.id === id);
                if (apt) {
                    openSidePanel(apt);
                }

                // Then fetch full details
                const appointment = await AdminAPI.getAppointment(id);
                if (appointment) {
                    openSidePanel(appointment);
                }

            } catch (error) {
                console.error('Error loading appointment:', error);
                showToast('Error al cargar los detalles', 'error');
            }
        }

        function openSidePanel(appointment) {
            const content = `
                <div class="gcal-detail-section">
                    <h2 class="gcal-detail-title">${appointment.service_name}</h2>
                </div>

                <div class="gcal-detail-section">
                    <div class="gcal-detail-row">
                        <i class="fas fa-clock gcal-detail-icon"></i>
                        <div class="gcal-detail-content">
                            <span class="gcal-detail-label">Fecha y hora</span>
                            <div class="gcal-detail-value">
                                ${formatDate(appointment.appointment_date)}<br>
                                ${appointment.start_time.slice(0, 5)} - ${appointment.end_time.slice(0, 5)} (${appointment.duration || calculateDuration(appointment.start_time, appointment.end_time)} min)
                            </div>
                        </div>
                    </div>

                    <div class="gcal-detail-row">
                        <i class="fas fa-user gcal-detail-icon"></i>
                        <div class="gcal-detail-content">
                            <span class="gcal-detail-label">Cliente</span>
                            <div class="gcal-detail-value">${appointment.client_name}</div>
                        </div>
                    </div>

                    <div class="gcal-detail-row">
                        <i class="fas fa-phone gcal-detail-icon"></i>
                        <div class="gcal-detail-content">
                            <span class="gcal-detail-label">Teléfono</span>
                            <div class="gcal-detail-value">${formatPhone(appointment.client_phone || appointment.phone)}</div>
                        </div>
                    </div>

                    <div class="gcal-detail-row">
                        <i class="fas fa-tag gcal-detail-icon"></i>
                        <div class="gcal-detail-content">
                            <span class="gcal-detail-label">Estado</span>
                            <div class="gcal-detail-value">
                                <span class="gcal-detail-badge ${appointment.status}">${getStatusLabel(appointment.status)}</span>
                            </div>
                        </div>
                    </div>

                    ${appointment.price ? `
                        <div class="gcal-detail-row">
                            <i class="fas fa-dollar-sign gcal-detail-icon"></i>
                            <div class="gcal-detail-content">
                                <span class="gcal-detail-label">Precio</span>
                                <div class="gcal-detail-value">${formatCurrency(appointment.service_price || appointment.price)}</div>
                            </div>
                        </div>
                    ` : ''}

                    ${appointment.notes ? `
                        <div class="gcal-detail-row">
                            <i class="fas fa-sticky-note gcal-detail-icon"></i>
                            <div class="gcal-detail-content">
                                <span class="gcal-detail-label">Notas</span>
                                <div class="gcal-detail-value">${appointment.notes}</div>
                            </div>
                        </div>
                    ` : ''}
                </div>

                <div class="gcal-detail-actions">
                    <button class="btn btn-secondary" onclick="closeSidePanel()">
                        <i class="fas fa-times"></i> Cerrar
                    </button>
                    <button class="btn btn-success" onclick="resendWhatsApp(${appointment.id})" title="Reenviar WhatsApp de confirmación" style="background: #25D366; border-color: #25D366;">
                        <i class="fab fa-whatsapp"></i> Reenviar WhatsApp
                    </button>
                    <button class="btn btn-primary" onclick="changeStatus(${appointment.id})">
                        <i class="fas fa-edit"></i> Cambiar Estado
                    </button>
                </div>
            `;

            document.getElementById('side-panel-content').innerHTML = content;
            document.getElementById('appointment-side-panel').classList.add('open');
            document.body.classList.add('side-panel-open');

            // Add overlay for mobile
            let overlay = document.getElementById('side-panel-overlay');
            if (!overlay) {
                overlay = document.createElement('div');
                overlay.id = 'side-panel-overlay';
                overlay.className = 'gcal-side-panel-overlay';
                overlay.onclick = closeSidePanel;
                document.body.appendChild(overlay);
            }
            setTimeout(() => overlay.classList.add('active'), 10);
        }

        function closeSidePanel() {
            document.getElementById('appointment-side-panel').classList.remove('open');
            document.body.classList.remove('side-panel-open');
            const overlay = document.getElementById('side-panel-overlay');
            if (overlay) {
                overlay.classList.remove('active');
            }
        }

        function calculateDuration(startTime, endTime) {
            const [startHour, startMin] = startTime.split(':').map(Number);
            const [endHour, endMin] = endTime.split(':').map(Number);
            return (endHour * 60 + endMin) - (startHour * 60 + startMin);
        }

        function changeStatus(id) {
            const content = `
                <div class="form-group">
                    <label for="new-status">Nuevo Estado</label>
                    <select id="new-status" class="search-input">
                        <option value="pending">Pendiente (Depósito)</option>
                        <option value="scheduled">Agendada</option>
                        <option value="confirmed">Confirmada</option>
                        <option value="in_progress">En Curso</option>
                        <option value="completed">Completada</option>
                        <option value="cancelled">Cancelada</option>
                        <option value="no_show">No Asistió</option>
                    </select>
                </div>
            `;

            const footer = `
                <button class="btn btn-secondary" onclick="statusModal.close()">Cancelar</button>
                <button class="btn btn-primary" onclick="updateStatus(${id})">Guardar</button>
            `;

            window.statusModal = showModal('statusModal', 'Cambiar Estado de Cita', content, footer);
        }

        async function updateStatus(id) {
            const newStatus = document.getElementById('new-status').value;

            try {
                await AdminAPI.updateAppointmentStatus(id, newStatus);
                showToast('Estado actualizado correctamente', 'success');
                window.statusModal.close();
                loadAppointments();
            } catch (error) {
                console.error('Error updating status:', error);
                showToast('Error al actualizar el estado', 'error');
            }
        }

        // Reenviar WhatsApp de confirmación
        async function resendWhatsApp(id) {
            try {
                showToast('Enviando WhatsApp...', 'info');

                // Usar fetchWithAuth que ya maneja la autenticación correctamente
                const data = await fetchWithAuth(`/admin/appointments/${id}/resend-whatsapp`, {
                    method: 'POST'
                });

                if (data && data.success) {
                    showToast(data.message || 'WhatsApp enviado correctamente', 'success');
                } else {
                    showToast(data?.error || 'Error al enviar WhatsApp', 'error');
                }
            } catch (error) {
                console.error('Error resending WhatsApp:', error);
                showToast(error.message || 'Error al enviar WhatsApp', 'error');
            }
        }

        function getStatusLabel(status) {
            const labels = {
                'pending': '⏳ Pendiente',
                'scheduled': 'Agendada',
                'confirmed': 'Confirmada',
                'in_progress': 'En Curso',
                'completed': 'Completada',
                'cancelled': 'Cancelada',
                'no_show': 'No Asistió'
            };
            return labels[status] || status;
        }

        // Load clients and services
        async function loadClientsAndServices() {
            try {
                const [clients, services] = await Promise.all([
                    AdminAPI.getClients(),
                    AdminAPI.getServices()
                ]);

                // Normalize responses - could be array or object with data property
                allClients = Array.isArray(clients) ? clients : (clients.data || clients.clients || []);
                allServices = Array.isArray(services) ? services : (services.data || services.services || []);

                console.log('Loaded clients:', allClients.length);
                console.log('Loaded services:', allServices.length);
            } catch (error) {
                console.error('Error loading clients/services:', error);
                showToast('Error al cargar clientes/servicios', 'error');
            }
        }

        // Open new appointment modal
        function openNewAppointmentModal(date, time) {
            const dateStr = typeof date === 'string' ? date : formatDateYMD(date);
            const timeStr = time || '09:00';

            // Generar opciones de hora (09:00 a 20:00 cada 30 min)
            let timeOptions = '';
            const startHour = 9;
            const endHour = 20;
            for (let h = startHour; h <= endHour; h++) {
                const hour = h.toString().padStart(2, '0');

                // :00
                const t1 = `${hour}:00`;
                const display1 = t1 > '11:59' ? (t1 === '12:00' ? '12:00 PM' : `${h - 12 || 12}:00 PM`) : `${h}:00 AM`;
                timeOptions += `<option value="${t1}" ${timeStr === t1 ? 'selected' : ''}>${display1}</option>`;

                // :30 (skip if endHour is reached and strict, but usually last appt is at closing - duration. Allow 20:00?)
                // Assuming last slot is 20:00
                if (h < endHour) {
                    const t2 = `${hour}:30`;
                    const display2 = t2 > '11:59' ? (t2 === '12:30' ? '12:30 PM' : `${h - 12 || 12}:30 PM`) : `${h}:30 AM`;
                    timeOptions += `<option value="${t2}" ${timeStr === t2 ? 'selected' : ''}>${display2}</option>`;
                }
            }
            // Add last slot 20:00 specifically if loop logic missed it or if needed
            // Loop goes <= endHour so 20:00 is added.

            const content = `
                <div class="form-group">
                    <label for="appointment-client" class="form-label">Cliente *</label>
                    <input list="client-list" id="appointment-client" class="form-input" placeholder="Buscar o escribir nombre..." required autocomplete="off">
                    <datalist id="client-list">
                        ${allClients.map(c => `<option value="${c.name} - ${formatPhone(c.phone)}">`).join('')}
                    </datalist>
                </div>

                <div class="form-group">
                    <label for="appointment-service" class="form-label">Servicio *</label>
                    <select id="appointment-service" class="form-select" required>
                        <option value="">Seleccionar servicio</option>
                        ${allServices.map(s => `<option value="${s.id}" data-duration="${s.duration_minutes}">${s.name} - ${formatCurrency(s.price)} (${s.duration_minutes} min)</option>`).join('')}
                    </select>
                </div>

                <div class="form-group">
                    <label for="appointment-date" class="form-label">Fecha *</label>
                    <input type="date" id="appointment-date" class="form-input" value="${dateStr}" required>
                </div>

                <div class="form-group">
                    <label for="appointment-time" class="form-label">Hora de inicio *</label>
                    <select id="appointment-time" class="form-select" required>
                        ${timeOptions}
                    </select>
                </div>

                <div class="form-group">
                    <label for="appointment-notes" class="form-label">Notas</label>
                    <textarea id="appointment-notes" class="form-textarea" rows="3" placeholder="Notas adicionales..."></textarea>
                </div>
            `;

            const footer = `
                <button class="btn btn-secondary" onclick="window.newAppointmentModal.close()">Cancelar</button>
                <button class="btn btn-primary" onclick="confirmNewAppointment()">Crear Cita</button>
            `;

            window.newAppointmentModal = showModal('newAppointmentModal', 'Nueva Cita', content, footer);
        }

        // Confirm before creating - ask about notifications
        function confirmNewAppointment() {
            const clientInputValue = document.getElementById('appointment-client').value;
            const serviceId = document.getElementById('appointment-service').value;
            const date = document.getElementById('appointment-date').value;
            const time = document.getElementById('appointment-time').value;

            // Validar campos
            const client = allClients.find(c => `${c.name} - ${formatPhone(c.phone)}` === clientInputValue);
            if (!client) {
                showToast('Por favor selecciona un cliente válido de la lista', 'warning');
                return;
            }

            if (!serviceId || !date || !time) {
                showToast('Por favor completa todos los campos requeridos', 'error');
                return;
            }

            // Obtener nombre del servicio
            const serviceSelect = document.getElementById('appointment-service');
            const serviceName = serviceSelect.options[serviceSelect.selectedIndex].text.split(' - ')[0];

            // Formatear fecha para mostrar
            const dateObj = new Date(date + 'T12:00:00');
            const formattedDate = dateObj.toLocaleDateString('es-MX', {
                weekday: 'long', day: 'numeric', month: 'long'
            });

            const confirmContent = `
                <div style="text-align: center; padding: 1rem 0;">
                    <i class="fas fa-calendar-check" style="font-size: 3rem; color: var(--gold); margin-bottom: 1rem;"></i>
                    <h3 style="margin-bottom: 1rem; color: var(--cream);">Confirmar Cita</h3>
                    <p style="color: var(--cream); margin-bottom: 0.5rem;"><strong>${client.name}</strong></p>
                    <p style="color: var(--text-muted); margin-bottom: 0.5rem;">${serviceName}</p>
                    <p style="color: var(--text-muted); margin-bottom: 1.5rem;">${formattedDate} a las ${time}</p>
                    
                    <div style="background: rgba(196, 163, 90, 0.1); border-radius: 8px; padding: 1rem; margin-bottom: 1rem;">
                        <p style="color: var(--cream); margin-bottom: 0.75rem; font-weight: 500;">
                            <i class="fas fa-bell"></i> ¿Enviar notificaciones al cliente?
                        </p>
                        <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; color: var(--cream); margin-bottom: 0.5rem;">
                            <input type="checkbox" id="send-whatsapp-notification" checked style="width: 18px; height: 18px; accent-color: var(--gold);">
                            <i class="fab fa-whatsapp" style="color: #25D366;"></i> WhatsApp
                        </label>
                        <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; color: var(--cream);">
                            <input type="checkbox" id="send-email-notification" checked style="width: 18px; height: 18px; accent-color: var(--gold);">
                            <i class="fas fa-envelope" style="color: #EA4335;"></i> Email
                        </label>
                    </div>
                </div>
            `;

            const confirmFooter = `
                <button class="btn btn-secondary" onclick="window.confirmModal.close()">Cancelar</button>
                <button class="btn btn-primary" onclick="createNewAppointment()">
                    <i class="fas fa-check"></i> Confirmar
                </button>
            `;

            window.confirmModal = showModal('confirmAppointmentModal', '', confirmContent, confirmFooter);
        }

        // Create new appointment
        async function createNewAppointment() {
            try {
                const clientInputValue = document.getElementById('appointment-client').value;
                const serviceId = document.getElementById('appointment-service').value;
                const date = document.getElementById('appointment-date').value;
                const time = document.getElementById('appointment-time').value;

                // Resolver Cliente desde el Datalist
                const client = allClients.find(c => `${c.name} - ${formatPhone(c.phone)}` === clientInputValue);
                if (!client) {
                    showToast('Por favor selecciona un cliente válido de la lista', 'warning');
                    return;
                }
                const clientId = client.id;
                const notes = document.getElementById('appointment-notes').value;

                // Obtener preferencias de notificación del modal de confirmación
                const sendWhatsApp = document.getElementById('send-whatsapp-notification')?.checked ?? true;
                const sendEmail = document.getElementById('send-email-notification')?.checked ?? true;

                if (!clientId || !serviceId || !date || !time) {
                    showToast('Por favor completa todos los campos requeridos', 'error');
                    return;
                }

                const appointmentData = {
                    client_id: parseInt(clientId),
                    service_id: parseInt(serviceId),
                    appointment_date: date,
                    start_time: time,
                    notes: notes,
                    send_whatsapp: sendWhatsApp,
                    send_email: sendEmail
                };

                await AdminAPI.createAppointment(appointmentData);
                showToast('Cita creada exitosamente', 'success');

                // Cerrar ambos modales
                if (window.confirmModal) window.confirmModal.close();
                if (window.newAppointmentModal) window.newAppointmentModal.close();

                loadAppointments();

            } catch (error) {
                console.error('Error creating appointment:', error);
                showToast(error.message || 'Error al crear la cita', 'error');
            }
        }

        // ================================
        // BLOQUEAR HORARIOS
        // ================================

        let blockedTimeSlots = [];

        async function loadBlockedTimeSlots(date) {
            try {
                const response = await fetch(`/api/admin/blocked-time-slots?date=${date}`, {
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('adminToken')}` }
                });
                blockedTimeSlots = await response.json();
                return blockedTimeSlots;
            } catch (error) {
                console.error('Error loading blocked slots:', error);
                return [];
            }
        }

        function openBlockTimeModal(date, time) {
            const modal = document.getElementById('block-time-modal');
            document.getElementById('block-date').value = date;
            document.getElementById('block-start-time').value = time;

            // Calcular hora de fin (1 hora después por defecto)
            const [hours, mins] = time.split(':').map(Number);
            const endHour = Math.min(hours + 1, 21);
            document.getElementById('block-end-time').value = `${endHour.toString().padStart(2, '0')}:${mins.toString().padStart(2, '0')}`;
            document.getElementById('block-reason').value = '';

            modal.classList.add('active');
        }

        function closeBlockModal() {
            document.getElementById('block-time-modal').classList.remove('active');
        }

        async function saveBlockedTime() {
            const date = document.getElementById('block-date').value;
            const startTime = document.getElementById('block-start-time').value;
            const endTime = document.getElementById('block-end-time').value;
            const reason = document.getElementById('block-reason').value;

            if (!date || !startTime || !endTime) {
                showToast('Por favor completa los campos requeridos', 'error');
                return;
            }

            if (startTime >= endTime) {
                showToast('La hora de inicio debe ser menor que la hora de fin', 'error');
                return;
            }

            try {
                const response = await fetch('/api/admin/blocked-dates', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('admin_token')}`
                    },
                    body: JSON.stringify({ date, start_time: startTime, end_time: endTime, reason })
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'Error al bloquear horario');
                }

                showToast('Horario bloqueado exitosamente', 'success');
                closeBlockModal();
                loadAppointments(); // Recargar calendario

            } catch (error) {
                console.error('Error blocking time:', error);
                showToast(error.message, 'error');
            }
        }

        async function deleteBlockedTime(id) {
            if (!confirm('¿Deseas desbloquear este horario?')) return;

            try {
                const response = await fetch(`/api/admin/blocked-time-slots/${id}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('adminToken')}` }
                });

                if (!response.ok) {
                    throw new Error('Error al eliminar');
                }

                showToast('Horario desbloqueado', 'success');
                loadAppointments();

            } catch (error) {
                showToast(error.message, 'error');
            }
        }

        // Initial load
        loadClientsAndServices();
        loadAppointments();
    </script>

    <!-- Modal para bloquear horarios -->
    <!-- Modal para bloquear horarios -->
    <div class="modal-overlay" id="block-time-modal">
        <div class="modal" style="max-width: 450px;">
            <div class="modal-header">
                <h3 class="modal-title"><i class="fas fa-ban" style="color: #EF5350; margin-right: 0.5rem;"></i>Bloquear
                    Horario</h3>
                <button class="modal-close" onclick="closeBlockModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div
                    style="background: rgba(239, 83, 80, 0.1); border: 1px solid rgba(239, 83, 80, 0.3); border-radius: 6px; padding: 1rem; margin-bottom: 1.5rem; display: flex; align-items: center; gap: 0.75rem;">
                    <i class="fas fa-info-circle" style="color: #EF5350;"></i>
                    <span style="font-size: 0.85rem; color: rgba(245, 243, 238, 0.8);">Este horario no estará disponible
                        para agendar citas.</span>
                </div>

                <div class="form-group" style="margin-bottom: 1.25rem;">
                    <label class="form-label" style="color: var(--gold); margin-bottom: 0.5rem; display: block;">
                        <i class="far fa-calendar"></i> Fecha
                    </label>
                    <input type="date" id="block-date" class="form-input" style="width: 100%;">
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1.25rem;">
                    <div class="form-group">
                        <label class="form-label" style="color: var(--gold); margin-bottom: 0.5rem; display: block;">
                            <i class="fas fa-clock"></i> Hora Inicio
                        </label>
                        <input type="time" id="block-start-time" class="form-input" style="width: 100%;">
                    </div>
                    <div class="form-group">
                        <label class="form-label" style="color: var(--gold); margin-bottom: 0.5rem; display: block;">
                            <i class="fas fa-clock"></i> Hora Fin
                        </label>
                        <input type="time" id="block-end-time" class="form-input" style="width: 100%;">
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label" style="color: var(--gold); margin-bottom: 0.5rem; display: block;">
                        <i class="fas fa-comment-alt"></i> Motivo <span
                            style="color: rgba(245, 243, 238, 0.5); font-weight: 400;">(opcional)</span>
                    </label>
                    <input type="text" id="block-reason" class="form-input"
                        placeholder="Ej: Comida, cita médica, reunión..." style="width: 100%;">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeBlockModal()">Cancelar</button>
                <button class="btn" onclick="saveBlockedTime()"
                    style="background: #EF5350; border-color: #EF5350; color: white;">
                    <i class="fas fa-ban"></i> Bloquear Horario
                </button>
            </div>
        </div>
    </div>

    <!-- Mobile Menu Script -->
    <!-- Mobile Menu Script Removed -->
    <script src="js/sidebar.js"></script>
</body>

</html>