<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard | Admin</title>
    <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@400;500;600;700&family=Montserrat:wght@300;400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="stylesheet" href="../css/admin.css">
</head>
<body>
    <!-- Mobile Menu Toggle -->
    <button class="mobile-menu-toggle" id="mobile-menu-toggle">
        <i class="fas fa-bars"></i>
    </button>
    
    <!-- Mobile Overlay -->
    <div class="mobile-overlay" id="mobile-overlay"></div>
    
    <!-- Sidebar -->
    <aside class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <img src="../assets/logo.png" alt="Logo" style="height: 60px; margin-bottom: 10px;">
            <span class="sidebar-subtitle">Admin</span>
        </div>
        
        <nav class="sidebar-nav">
            <a href="/admin/" class="nav-item active">
                <span class="nav-icon"><i class="fas fa-chart-line"></i></span>
                <span>Dashboard</span>
            </a>
            <a href="/admin/calendario.html" class="nav-item">
                <span class="nav-icon"><i class="far fa-calendar-alt"></i></span>
                <span>Calendario</span>
            </a>
            <a href="/admin/clientes.html" class="nav-item">
                <span class="nav-icon"><i class="fas fa-users"></i></span>
                <span>Clientes</span>
            </a>
            <a href="/admin/membresias.html" class="nav-item">
                <span class="nav-icon"><i class="fas fa-crown"></i></span>
                <span>Membres√≠as</span>
            </a>
            <a href="/admin/reportes.html" class="nav-item">
                <span class="nav-icon"><i class="fas fa-file-invoice-dollar"></i></span>
                <span>Reportes</span>
            </a>
        </nav>
        
        <div class="sidebar-footer">
            <button class="btn-logout" onclick="logout()">Cerrar Sesi√≥n</button>
        </div>
    </aside>
    
    <!-- Main Content -->
    <main class="main-content">
        <header class="main-header">
            <div class="header-title">
                <h2>Dashboard</h2>
                <p class="header-date" id="current-date"></p>
            </div>
            <div class="header-user">
                <span id="admin-name">Admin</span>
            </div>
        </header>
        
        <!-- Stats Cards -->
        <section class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon"><i class="far fa-calendar-check"></i></div>
                <div class="stat-content">
                    <span class="stat-value" id="stat-appointments">0</span>
                    <span class="stat-label">Citas Hoy</span>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon"><i class="fas fa-dollar-sign"></i></div>
                <div class="stat-content">
                    <span class="stat-value" id="stat-sales">$0</span>
                    <span class="stat-label">Ventas Hoy</span>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon"><i class="fas fa-crown"></i></div>
                <div class="stat-content">
                    <span class="stat-value" id="stat-memberships">0</span>
                    <span class="stat-label">Membres√≠as Activas</span>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon"><i class="fas fa-users"></i></div>
                <div class="stat-content">
                    <span class="stat-value" id="stat-clients">0</span>
                    <span class="stat-label">Clientes Totales</span>
                </div>
            </div>
        </section>
        
        <!-- Upcoming Appointments -->
        <section class="content-section">
            <div class="section-header">
                <h3>Citas de Hoy</h3>
                <a href="/admin/calendario.html" class="section-link">Ver todas ‚Üí</a>
            </div>
            
            <div id="appointments-container">
                <div class="loading">
                    <div class="loading-spinner"></div>
                    <p>Cargando citas...</p>
                </div>
            </div>
        </section>
        
        <!-- Recent Activity -->
        <section class="content-section">
            <div class="section-header">
                <h3>Actividad Reciente</h3>
            </div>
            
            <div id="activity-container">
                <div class="loading">
                    <div class="loading-spinner"></div>
                    <p>Cargando actividad...</p>
                </div>
            </div>
        </section>
    </main>
    
    <script src="../js/admin.js"></script>
    <script>
        // Verificar autenticaci√≥n al cargar
        checkAuth();
        
        // Mostrar nombre de usuario
        const adminUser = JSON.parse(localStorage.getItem('admin_user') || '{}');
        document.getElementById('admin-name').textContent = adminUser.name || 'Admin';
        
        // Mostrar fecha actual
        const dateOptions = {
            weekday: 'long',
            day: 'numeric',
            month: 'long',
            year: 'numeric'
        };
        document.getElementById('current-date').textContent = 
            new Date().toLocaleDateString('es-MX', dateOptions);
        
        // Cargar dashboard
        async function loadDashboard() {
            try {
                // Obtener estad√≠sticas del dashboard
                const data = await fetchWithAuth('/api/admin/dashboard');
                
                // Actualizar stats
                document.getElementById('stat-appointments').textContent = 
                    data.stats.appointments_today || 0;
                document.getElementById('stat-sales').textContent = 
                    formatCurrency(data.stats.sales_today || 0);
                document.getElementById('stat-memberships').textContent = 
                    data.stats.active_memberships || 0;
                document.getElementById('stat-clients').textContent = 
                    data.stats.total_clients || 0;
                
                // Renderizar citas de hoy
                renderAppointments(data.upcoming_appointments || []);
                
                // Renderizar actividad reciente
                renderActivity(data.recent_activity || []);
                
            } catch (error) {
                console.error('Error loading dashboard:', error);
                showError('appointments-container', 'Error al cargar las citas');
                showError('activity-container', 'Error al cargar la actividad');
            }
        }
        
        function renderAppointments(appointments) {
            const container = document.getElementById('appointments-container');
            
            if (appointments.length === 0) {
                container.innerHTML = '<p class="empty-message">No hay citas programadas para hoy</p>';
                return;
            }
            
            const html = `
                <div class="appointments-list">
                    ${appointments.map(apt => `
                        <div class="appointment-item">
                            <div class="appointment-time">${apt.start_time.slice(0, 5)}</div>
                            <div class="appointment-info">
                                <span class="appointment-client" style="border-left: 3px solid ${apt.client_color || '#C4A35A'}">
                                    ${apt.client_name}
                                </span>
                                <span class="appointment-service">${apt.service_name}</span>
                            </div>
                            <div class="appointment-status ${apt.status}">${getStatusLabel(apt.status)}</div>
                            <div class="appointment-actions">
                                <button class="btn-icon" onclick="viewAppointment(${apt.id})" title="Ver detalles">üëÅÔ∏è</button>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
            
            container.innerHTML = html;
        }
        
        function renderActivity(activities) {
            const container = document.getElementById('activity-container');
            
            if (activities.length === 0) {
                container.innerHTML = '<p class="empty-message">No hay actividad reciente</p>';
                return;
            }
            
            const html = `
                <div class="appointments-list">
                    ${activities.map(activity => `
                        <div class="appointment-item">
                            <div class="appointment-time">${formatTime(activity.created_at)}</div>
                            <div class="appointment-info">
                                <span class="appointment-client">${activity.description}</span>
                                <span class="appointment-service">${activity.details || ''}</span>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
            
            container.innerHTML = html;
        }
        
        function getStatusLabel(status) {
            const labels = {
                'scheduled': 'Agendada',
                'confirmed': 'Confirmada',
                'in_progress': 'En Curso',
                'completed': 'Completada',
                'cancelled': 'Cancelada',
                'no_show': 'No Asisti√≥'
            };
            return labels[status] || status;
        }
        
        function formatTime(datetime) {
            const date = new Date(datetime);
            const now = new Date();
            const diffHours = Math.floor((now - date) / (1000 * 60 * 60));
            
            if (diffHours < 1) {
                const diffMinutes = Math.floor((now - date) / (1000 * 60));
                return `Hace ${diffMinutes} min`;
            } else if (diffHours < 24) {
                return `Hace ${diffHours}h`;
            } else {
                return date.toLocaleDateString('es-MX', { day: 'numeric', month: 'short' });
            }
        }
        
        function viewAppointment(id) {
            window.location.href = `/admin/calendario.html?appointment=${id}`;
        }
        
        function showError(containerId, message) {
            const container = document.getElementById(containerId);
            container.innerHTML = `<p class="empty-message" style="color: var(--error)">${message}</p>`;
        }
        
        // Cargar datos al iniciar
        loadDashboard();
        
        // Recargar cada 30 segundos
        setInterval(loadDashboard, 30000);
    </script>
    
    <!-- Mobile Menu Script -->
    <script>
        const mobileMenuToggle = document.getElementById('mobile-menu-toggle');
        const sidebar = document.getElementById('sidebar');
        const mobileOverlay = document.getElementById('mobile-overlay');
        
        if (mobileMenuToggle && sidebar && mobileOverlay) {
            mobileMenuToggle.addEventListener('click', () => {
                sidebar.classList.toggle('active');
            });
            
            mobileOverlay.addEventListener('click', () => {
                sidebar.classList.remove('active');
            });
            
            document.querySelectorAll('.sidebar .nav-item').forEach(item => {
                item.addEventListener('click', () => {
                    sidebar.classList.remove('active');
                });
            });
        }
    </script>
</body>
</html>
